<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Telegram Web Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root{
        --bg-1:#000000;
        --brand:#b142b4;
        --ink:#e8e6f2;
        --ink-dim:#b8b5c7;
        --panel:#0f1017;
        --panel-2:#141523;
        --pill:#6d4df2;
        --pill-2:#9a66ff;
        --stroke:rgba(255,255,255,0.08);
        --glass:rgba(255,255,255,0.06);
        --glass-2:rgba(177,66,180,0.12);
        --shadow:0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.02);
        --radius:18px;
        --radius-lg:22px;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        color:var(--ink);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
        display:flex;
        align-items:flex-start;
        justify-content:center;
        background:#000;
        overflow-x:hidden;
      }
      /* brand gradient without hard banding */
      body::before{
        content:"";
        position:fixed; inset:0; z-index:-2;
        background:
          radial-gradient(1200px 700px at 85% -10%, rgba(177,66,180,.35), transparent 60%),
          radial-gradient(900px 500px at 12% 15%, rgba(177,66,180,.22), transparent 58%),
          linear-gradient(180deg, #000 0%, #07070a 35%, #0e0914 60%, #160a24 80%, #1b0b2b 92%, #b142b4 140%);
        background-attachment:fixed;
        filter:saturate(110%);
      }
      /* subtle vignette to soften edges further */
      body::after{
        content:"";
        position:fixed; inset:-50px; z-index:-1;
        pointer-events:none;
        background:radial-gradient(120% 100% at 50% 0%, transparent 0%, transparent 55%, rgba(0,0,0,.35) 100%);
      }

      .wrap{
        width:min(920px, 96vw);
        padding:24px 16px 120px;
      }

      /* header */
      .hero{
        text-align:center;
        margin-bottom:16px;
      }
      .brand-row{
        display:flex; align-items:center; justify-content:center; gap:12px;
        margin-bottom:6px;
      }
      .dot{width:12px;height:12px;border-radius:50%;background:var(--brand); box-shadow:0 0 22px rgba(177,66,180,.6)}
      .dot.big{width:18px;height:18px}
      h1{
        font-weight:800; letter-spacing:.5px; margin:0 0 6px;
      }
      .hello{font-size:16px;color:var(--ink);opacity:.9;margin:4px 0}
      .motd{font-size:14px;color:var(--ink-dim);margin:0}

      /* common cards */
      .card{
        background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
        border:1px solid var(--stroke);
        border-radius:var(--radius-lg);
        padding:16px;
        box-shadow:var(--shadow);
        backdrop-filter:saturate(120%) blur(2px);
        margin:18px auto;
      }
      .title{
        font-weight:800; font-size:22px; letter-spacing:.2px; margin:0 0 12px;
      }

      /* controls */
      .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
      .pill{
        border:none; cursor:pointer;
        padding:12px 20px; font-weight:800; font-size:15px;
        color:#fff; border-radius:999px;
        background:linear-gradient(135deg, var(--pill), var(--pill-2));
        box-shadow:0 6px 20px rgba(109,77,242,.35), inset 0 1px 0 rgba(255,255,255,.08);
        transition:transform .08s ease, box-shadow .2s ease;
      }
      .pill:active{transform:translateY(1px)}
      .ghost{
        background:transparent; border:1px solid var(--stroke); color:var(--ink);
      }
      .input, .select, textarea{
        width:100%;
        background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border:1px solid var(--stroke); color:var(--ink);
        padding:12px 14px; border-radius:14px; outline:none;
      }
      .select{appearance:none}
      textarea{min-height:120px; resize:vertical}
      .list{list-style:none; padding:0; margin:10px 0 0}
      .item{
        border:1px solid var(--stroke);
        border-radius:16px; padding:14px;
        background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      }
      .pick{
        width:54px; height:54px; border-radius:999px; flex:0 0 auto;
        display:flex; align-items:center; justify-content:center;
        background:linear-gradient(135deg, var(--pill), var(--pill-2));
        font-weight:800;
        box-shadow:0 6px 20px rgba(109,77,242,.35);
        border:none; color:#fff; cursor:pointer;
      }
      pre{
        white-space:pre-wrap; color:#dfe1ff; background:rgba(0,0,0,.35);
        border:1px solid var(--stroke); border-radius:14px; padding:12px; margin:8px 0 0;
      }
      .muted{color:var(--ink-dim); font-size:13px}

      .split{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center}
      .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
      @media (max-width:700px){ .two{grid-template-columns:1fr} .split{grid-template-columns:1fr} }

      /* search in chats */
      .search{position:relative}
      .search input{padding-left:40px}
      .search:before{
        content:"ðŸ”Ž"; position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6; pointer-events:none;
      }

      /* sticky close button styling */
      .mainBtn{
        position:sticky; bottom:16px; display:block; width:100%;
        background:#5aa1ff; border:none; color:#fff;
        font-weight:800; border-radius:16px; padding:16px; font-size:16px;
        box-shadow:0 10px 30px rgba(90,161,255,.35);
      }

      /* small inline edit cluster */
      .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
      .mini{padding:8px 12px; font-size:13px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- HEADER -->
      <header class="hero">
        <div class="brand-row">
          <div class="dot big"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h1>Team Mini App</h1>
        <p id="who" class="hello">â€¦</p>
        <p id="motd" class="motd">â€¦</p>
      </header>

      <!-- CHATS -->
      <section class="card">
        <h2 class="title">Chats</h2>
        <div class="row">
          <div class="search" style="flex:1">
            <input id="chatSearch" class="input" placeholder="Search chatsâ€¦" />
          </div>
          <button id="loadChats" class="pill">Load chats</button>
        </div>
        <ul id="chats" class="list"></ul>
        <p class="muted">Tip: click a chat to fill all inputs below.</p>
      </section>

      <!-- QUICK SUMMARY -->
      <section class="card">
        <h2 class="title">Quick Summary</h2>
        <div class="split">
          <input id="chatIdSum" class="input" placeholder="chat_id" />
          <button id="doSummary" class="pill">Summarize</button>
        </div>
        <pre id="summaryOut"></pre>
      </section>

      <!-- LATEST MESSAGES -->
      <section class="card">
        <h2 class="title">Latest Messages</h2>
        <div class="split">
          <input id="chatId" class="input" placeholder="chat_id" />
          <button id="loadMsgs" class="pill">Load latest (5)</button>
        </div>
        <pre id="msgs"></pre>
      </section>

      <!-- COMPANY & STATUS -->
      <section class="card">
        <h2 class="title">Company & Status</h2>

        <!-- Get / Edit Blurb -->
        <div class="split">
          <input id="chatIdCompany" class="input" placeholder="chat_id for blurb" />
          <div class="inline">
            <button id="getBlurb" class="pill">Get blurb</button>
            <button id="editBlurb" class="pill ghost mini">Edit</button>
          </div>
        </div>
        <div id="blurbView">
          <pre id="blurbOut">No blurb found.</pre>
        </div>
        <div id="blurbEdit" style="display:none; margin-top:10px">
          <textarea id="blurbArea" class="input" placeholder="Edit blurbâ€¦"></textarea>
          <div class="inline" style="margin-top:8px">
            <button id="saveBlurb" class="pill mini">Save</button>
            <button id="cancelBlurb" class="pill ghost mini">Cancel</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--stroke);margin:16px 0" />

        <!-- Get / Edit Status -->
        <div class="split">
          <input id="chatIdStatus" class="input" placeholder="chat_id for status" />
          <div class="inline">
            <button id="getStatus" class="pill">Get status</button>
            <button id="editStatus" class="pill ghost mini">Edit</button>
          </div>
        </div>
        <div id="statusView">
          <pre id="statusOut">â€”</pre>
        </div>
        <div id="statusEdit" style="display:none; margin-top:10px">
          <select id="statusSel" class="select">
            <option>Talking stage</option>
            <option>Awaiting SoW</option>
            <option>SoW signed</option>
            <option>Preparing campaign</option>
            <option>Campaign live</option>
            <option>Awaiting report</option>
            <option>Campaign finished</option>
          </select>
          <div class="inline" style="margin-top:8px">
            <button id="saveStatus" class="pill mini">Save</button>
            <button id="cancelStatus" class="pill ghost mini">Cancel</button>
          </div>
        </div>
      </section>

      <button class="mainBtn" id="closeBtn">Close</button>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      // header info
      const user = tg.initDataUnsafe?.user;
      const who = document.getElementById('who');
      who.textContent = user
        ? `Hello, ${user.first_name} (@${user.username || 'no username'}) â€” id: ${user.id}`
        : 'Open this from Telegram to see user info.';

      const motd = document.getElementById('motd');
      (function setMotd(){
        const day = new Date().getDay(); // 0 Sun â€¦ 6 Sat
        const msg = {
          1: "set the tone, plan one meaningful step.",            // Mon
          2: "keep going â€” crush small tasks, split big ones.",     // Tue
          3: "halfway there, breathe & recalibrate.",               // Wed
          4: "steady pace today, stay productive.",                 // Thu
          5: "final push â€” then enjoy your weekend!",               // Fri
          0: "light planning & recovery day.",                      // Sun
          6: "wrap up & prep a stress-free Monday."                 // Sat
        }[day] || "grab one tiny win and recharge.";
        motd.textContent = `Hey ${user?.first_name || 'there'}, today is the perfect day to ${msg}`;
      })();

      // close button
      document.getElementById('closeBtn').onclick = () => tg.close();

      // CHATS
      const chatsEl = document.getElementById('chats');
      const searchEl = document.getElementById('chatSearch');
      let chatsCache = [];

      function renderChats(list){
        chatsEl.innerHTML = list.map(c => `
          <li class="item">
            <div>
              <div style="font-weight:700">${c.title || '(no title)'}</div>
              <div class="muted">${c.username ? '@'+c.username+' â€¢ ' : ''}${c.id}</div>
            </div>
            <button class="pick" data-id="${c.id}">Pick</button>
          </li>
        `).join('');
      }

      document.getElementById('loadChats').onclick = async () => {
        const res = await fetch('/api/chats', { headers:{'x-telegram-init-data': tg.initData} });
        if(!res.ok) { chatsEl.innerHTML = `<li class="muted">Error: ${await res.text()}</li>`; return; }
        chatsCache = await res.json();
        renderChats(chatsCache);
      };

      // search
      searchEl.addEventListener('input', () => {
        const q = searchEl.value.trim().toLowerCase();
        if(!q) { renderChats(chatsCache); return; }
        const filtered = chatsCache.filter(c =>
          String(c.id).includes(q) ||
          (c.title || '').toLowerCase().includes(q) ||
          (c.username || '').toLowerCase().includes(q)
        );
        renderChats(filtered);
      });

      // pick â†’ fill all chat_id inputs
      chatsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.pick');
        if(!btn) return;
        const id = btn.dataset.id;
        ['chatId','chatIdSum','chatIdCompany','chatIdStatus'].forEach(k=>{
          const el = document.getElementById(k);
          if(el) el.value = id;
        });
        // little feedback
        btn.textContent = 'âœ“';
        setTimeout(()=>btn.textContent='Pick', 700);
      });

      // SUMMARY
      document.getElementById('doSummary').onclick = async () => {
        const id = document.getElementById('chatIdSum').value.trim();
        if(!id) return alert('Enter chat_id');
        const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=160`, {
          headers:{'x-telegram-init-data': tg.initData}
        });
        if(!res.ok){ document.getElementById('summaryOut').textContent = `Error: ${await res.text()}`; return; }
        const data = await res.json();
        document.getElementById('summaryOut').textContent =
          data.text
          ? data.text
          : `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`;
      };

      // LATEST MESSAGES (limit 5)
      document.getElementById('loadMsgs').onclick = async () => {
        const id = document.getElementById('chatId').value.trim();
        if(!id) return alert('Enter chat_id');
        const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=5`, {
          headers:{'x-telegram-init-data': tg.initData}
        });
        if(!res.ok){ document.getElementById('msgs').textContent = `Error: ${await res.text()}`; return; }
        const msgs = await res.json();
        document.getElementById('msgs').textContent =
          msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n');
      };

      // BLURB (get/edit)
      const blurbView = document.getElementById('blurbView');
      const blurbEdit = document.getElementById('blurbEdit');
      const blurbOut = document.getElementById('blurbOut');
      const blurbArea = document.getElementById('blurbArea');

      document.getElementById('getBlurb').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if(!id) return alert('Enter chat_id');
        const r = await fetch(`/api/company-blurb?chat_id=${encodeURIComponent(id)}`, {
          headers:{'x-telegram-init-data': tg.initData}
        });
        if(!r.ok){ blurbOut.textContent = `Error: ${await r.text()}`; return; }
        const data = await r.json();
        blurbOut.textContent = data.blurb ? data.blurb : (data.note || 'No blurb found.');
      };

      document.getElementById('editBlurb').onclick = async () => {
        // prefill editor with current text
        blurbArea.value = blurbOut.textContent && blurbOut.textContent !== 'No blurb found.' ? blurbOut.textContent : '';
        blurbView.style.display = 'none';
        blurbEdit.style.display = '';
      };
      document.getElementById('cancelBlurb').onclick = () => {
        blurbEdit.style.display = 'none';
        blurbView.style.display = '';
      };
      document.getElementById('saveBlurb').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if(!id) return alert('Enter chat_id');
        const blurb = blurbArea.value.trim();
        const r = await fetch('/api/company', {
          method:'POST',
          headers:{'Content-Type':'application/json','x-telegram-init-data': tg.initData},
          body: JSON.stringify({ chat_id: id, blurb })
        });
        const txt = await r.text();
        // try to refresh view
        blurbOut.textContent = blurb || 'No blurb found.';
        blurbEdit.style.display = 'none';
        blurbView.style.display = '';
      };

      // STATUS (get/edit)
      const statusView = document.getElementById('statusView');
      const statusEdit = document.getElementById('statusEdit');
      const statusOut = document.getElementById('statusOut');
      const statusSel = document.getElementById('statusSel');

      document.getElementById('getStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if(!id) return alert('Enter chat_id');
        const r = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, {
          headers:{'x-telegram-init-data': tg.initData}
        });
        if(!r.ok){ statusOut.textContent = `Error: ${await r.text()}`; return; }
        const data = await r.json();
        statusOut.textContent = data?.status || 'â€”';
      };

      document.getElementById('editStatus').onclick = () => {
        // prefill from view if possible
        const cur = statusOut.textContent.trim();
        const o = Array.from(statusSel.options).find(o=>o.value===cur);
        if(o) statusSel.value = cur;
        statusView.style.display = 'none';
        statusEdit.style.display = '';
      };
      document.getElementById('cancelStatus').onclick = () => {
        statusEdit.style.display = 'none';
        statusView.style.display = '';
      };
      document.getElementById('saveStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if(!id) return alert('Enter chat_id');
        const status = statusSel.value;
        const r = await fetch('/api/status', {
          method:'POST',
          headers:{'Content-Type':'application/json','x-telegram-init-data': tg.initData},
          body: JSON.stringify({ chat_id: id, status })
        });
        await r.text(); // ignore body
        statusOut.textContent = status;
        statusEdit.style.display = 'none';
        statusView.style.display = '';
      };
    </script>
  </body>
</html>
