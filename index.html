<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TRBE — Team Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Telegram Web Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Manrope (TRBE-like) -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Tune these to match trbe.me even closer */
      --bg-1: #0b0a0d;
      --bg-2: #131017;
      --glass: rgba(255,255,255,.06);
      --glass-strong: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.12);
      --text: #EDEAF5;
      --muted: #B9B4C8;
      --accent-1: #6D4AFF;      /* left of gradient */
      --accent-2: #B075FF;      /* right of gradient */
      --accent-3: #2CE3FF;      /* subtle cyan glow */
      --radius: 16px;
      --radius-lg: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
      --font: "Manrope", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(109,74,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(44,227,255,.15), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      padding: 18px 16px 28px;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }

    .hero{
      display: grid;
      gap: 8px;
      margin: 6px 0 18px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 800; letter-spacing: .4px;
    }
    .pill{
      font-size: 12px; color: var(--muted);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    h1{
      font-size: clamp(28px, 4.8vw, 44px);
      line-height: 1.05;
      margin: 2px 0 0;
      font-weight: 800;
      letter-spacing: -.5px;
    }
    .gradient{
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip: text; background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .motd{
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }

    .grid{
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1.1fr 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h3{
      font-size: 16px;
      margin: 0 0 10px;
      font-weight: 700;
    }
    .hint{ color: var(--muted); font-size: 12px; }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom: 10px;
    }

    input, textarea, select{
      width: 100%;
      color: var(--text);
      background: rgba(255,255,255,.03);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    textarea{ min-height: 110px; resize: vertical; }

    .btn{
      appearance: none;
      border: 0;
      color: #fff;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      box-shadow:
        0 8px 20px rgba(109,74,255,.25),
        inset 0 1px 0 rgba(255,255,255,.12);
      transition: transform .05s ease, filter .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color: var(--text);
    }

    .list{
      list-style: none; padding: 0; margin: 8px 0 0;
      max-height: 260px; overflow: auto;
      border: 1px solid var(--stroke);
      border-radius: 12px;
    }
    .row{
      display:flex; justify-content: space-between; gap:10px;
      padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      cursor: pointer;
    }
    .row:hover{ background: rgba(255,255,255,.06); }
    .row:last-child{ border-bottom: 0; }
    .sub{ font-size: 12px; color: var(--muted); }

    pre.out{
      background: rgba(0,0,0,.35);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0 0;
      white-space: pre-wrap;
      max-height: 280px; overflow: auto;
    }

    .two{
      display:grid; gap:10px;
      grid-template-columns: 1fr 120px;
      align-items: center;
    }
    .three{ display:grid; gap:10px; grid-template-columns: 1fr 110px 110px; }

    .spinner{
      width:16px; height:16px; border-radius:50%;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: #fff; animation: spin .7s linear infinite;
      display:inline-block; vertical-align:-3px; margin-left:6px;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: 999px; padding: 10px 14px; font-size: 14px; color: var(--text);
      box-shadow: var(--shadow);
      display:none;
    }

    .badge{
      padding: 2px 8px; border-radius: 999px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      font-size: 11px; font-weight: 800; letter-spacing:.2px;
    }

    .note{ color: var(--muted); font-size: 12px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <div class="hero">
      <div class="brand">
        <span class="pill">TRBE Team Mini App</span>
      </div>
      <h1>
        Top Web3 ops, one panel. <span class="gradient">TRBE</span>
      </h1>
      <div id="who" class="motd"></div>
      <div id="motd" class="motd"></div>
    </div>

    <div class="grid">

      <!-- CHATS PANEL -->
      <section class="card">
        <h3>Chats <span class="badge" id="chCount">0</span></h3>

        <div class="toolbar">
          <div class="two" style="grid-template-columns: 1fr 140px;">
            <input id="searchChats" placeholder="Search chats by title, @username, or id…" />
            <button class="btn" id="loadChats">Load chats</button>
          </div>
        </div>

        <ul id="chats" class="list"></ul>
        <div class="note">Tip: click a chat to fill all inputs below.</div>
      </section>

      <!-- SUMMARY PANEL -->
      <section class="card">
        <h3>Quick Summary</h3>
        <div class="two">
          <input id="chatIdSum" placeholder="Enter chat_id for summary" />
          <button class="btn" id="doSummary">Summarize</button>
        </div>
        <pre id="summaryOut" class="out"></pre>
      </section>

      <!-- MESSAGES PANEL -->
      <section class="card">
        <h3>Latest Messages</h3>
        <div class="two">
          <input id="chatIdMsg" placeholder="Enter chat_id for messages" />
          <button class="btn" id="loadMsgs">Load latest</button>
        </div>
        <pre id="msgsOut" class="out"></pre>
      </section>

      <!-- COMPANY + STATUS PANEL -->
      <section class="card">
        <h3>Company & Status</h3>

        <div class="two">
          <input id="chatIdCompany" placeholder="Enter chat_id for company details" />
          <button class="btn" id="getCompany">Get company</button>
        </div>
        <pre id="companyOut" class="out"></pre>

        <div class="two" style="margin-top:10px">
          <input id="chatIdStatus" placeholder="Enter chat_id for status" />
          <button class="btn" id="getStatus">Get status</button>
        </div>
        <pre id="statusOut" class="out"></pre>
      </section>

    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Telegram boot ----------
    const tg = window.Telegram?.WebApp;
    tg?.ready?.();

    // Greeting + day-of-week MOTD
    const user = tg?.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      user
        ? `Hello, ${user.first_name} (@${user.username || 'no username'}) — id: ${user.id}`
        : 'Open this from Telegram to see user info.';

    const day = (new Date()).getDay(); // Sun=0..Sat=6
    const motdMap = {
      1: 'Monday — set the tone: plan the week and identify one “level-up” step.',
      2: 'Tuesday — momentum day! Kill the smallest tasks and split big ones.',
      3: 'Wednesday — breathe, you’re half-way through. Review blockers.',
      4: 'Thursday — keep steady progress, stay productive without burning out.',
      5: 'Friday — final push, then enjoy the weekend. Tie loose ends.',
      0: 'Sunday — light planning beats heavy grinding. Prep your week.',
      6: 'Saturday — rest & reflect. Tiny wins only.'
    };
    document.getElementById('motd').textContent = motdMap[day] || '';

    // Close button in Telegram main button
    tg?.MainButton?.setText?.('Close');
    tg?.MainButton?.onClick?.(() => tg.close());
    tg?.MainButton?.show?.();

    // ---------- Helpers ----------
    const H = {
      headers() {
        return { 'x-telegram-init-data': tg?.initData || '' };
      },
      set(outId, val) { const el = document.getElementById(outId); if (el) el.textContent = val; },
      spinHTML(txt){ return `${txt} <span class="spinner"></span>`; },
      toast(msg){
        const t = document.getElementById('toast');
        t.textContent = msg; t.style.display = 'block';
        setTimeout(()=> t.style.display='none', 1800);
      },
      pickChat(id){
        // fill all inputs with chosen chat_id
        ['chatIdMsg','chatIdSum','chatIdCompany','chatIdStatus'].forEach(k=>{
          const el = document.getElementById(k); if (el) el.value = id;
        });
      }
    };

    // ---------- Load chats + client-side search ----------
    const chatsList = document.getElementById('chats');
    const chCount = document.getElementById('chCount');
    let chatsCache = [];

    async function loadChats(){
      chatsList.innerHTML = `<li class="row"><div>Loading…</div></li>`;
      try {
        const r = await fetch('/api/chats', { headers: H.headers() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        chatsCache = data;
        renderChats(data);
        chCount.textContent = data.length;
        H.toast('Chats loaded');
      } catch (e) {
        chatsList.innerHTML = `<li class="row"><div>Failed to load chats</div><div class="sub">${e.message || e}</div></li>`;
      }
    }

    function renderChats(items){
      if (!items?.length){
        chatsList.innerHTML = `<li class="row"><div>Nothing found</div></li>`;
        return;
      }
      chatsList.innerHTML = items.map(c=>{
        const uname = c.username ? `@${c.username}` : '';
        return `<li class="row" data-id="${c.id}">
                  <div>
                    <div>${c.title}</div>
                    <div class="sub">${uname ? uname + ' • ' : ''}${c.id}</div>
                  </div>
                  <div class="badge">Pick</div>
                </li>`;
      }).join('');
    }

    document.getElementById('loadChats').onclick = loadChats;

    chatsList.addEventListener('click', (e)=>{
      const li = e.target.closest('.row'); if (!li) return;
      const id = li.getAttribute('data-id');
      H.pickChat(id);
      H.toast(`Selected chat ${id}`);
    });

    document.getElementById('searchChats').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if (!q){ renderChats(chatsCache); return; }
      const filtered = chatsCache.filter(c =>
        String(c.id).includes(q) ||
        (c.title||'').toLowerCase().includes(q) ||
        (c.username||'').toLowerCase().includes(q)
      );
      renderChats(filtered);
      chCount.textContent = filtered.length;
    });

    // ---------- Latest messages ----------
    document.getElementById('loadMsgs').onclick = async () => {
      const id = document.getElementById('chatIdMsg').value.trim();
      if (!id) return alert('Enter chat_id');
      H.set('msgsOut', 'Loading…');
      try {
        const r = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, { headers: H.headers() });
        if (!r.ok) throw new Error(await r.text());
        const msgs = await r.json();
        if (!msgs?.length){ H.set('msgsOut', 'No messages.'); return; }
        H.set('msgsOut', msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n'));
      } catch (e) {
        H.set('msgsOut', `Error: ${e.message || e}`);
      }
    };

    // ---------- Summary ----------
    document.getElementById('doSummary').onclick = async () => {
      const id = document.getElementById('chatIdSum').value.trim();
      if (!id) return alert('Enter chat_id');
      H.set('summaryOut', H.spinHTML('Summarizing…'));
      try {
        const r = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=120`, { headers: H.headers() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        H.set('summaryOut',
          data.text
            ? data.text
            : `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`
        );
      } catch (e) {
        H.set('summaryOut', `Error: ${e.message || e}`);
      }
    };

    // ---------- Company details ----------
    document.getElementById('getCompany').onclick = async () => {
      const id = document.getElementById('chatIdCompany').value.trim();
      if (!id) return alert('Enter chat_id');
      H.set('companyOut', 'Loading…');
      try {
        const r = await fetch(`/api/company-auto?chat_id=${encodeURIComponent(id)}`, { headers: H.headers() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        H.set('companyOut', data?.text || 'No blurb found.');
      } catch (e) {
        H.set('companyOut', `Error: ${e.message || e}`);
      }
    };

    // ---------- Status ----------
    document.getElementById('getStatus').onclick = async () => {
      const id = document.getElementById('chatIdStatus').value.trim();
      if (!id) return alert('Enter chat_id');
      H.set('statusOut', 'Loading…');
      try {
        const r = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers: H.headers() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        H.set('statusOut', data?.status || 'No status.');
      } catch (e) {
        H.set('statusOut', `Error: ${e.message || e}`);
      }
    };
  </script>
</body>
</html>
