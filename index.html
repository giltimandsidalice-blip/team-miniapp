<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #fff; background: #000; }
      .card { border: 1px solid #444; border-radius: 12px; padding: 16px; margin-top: 12px; }
      pre { white-space: pre-wrap; }
      input, textarea, select { padding: 8px; border-radius: 8px; border: 1px solid #555; background:#111; color:#fff; }
      button { padding: 8px 12px; border-radius: 12px; border: 1px solid #666; background:#222; color:#fff; cursor: pointer; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .grow { flex:1 1 240px; }
      small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color:#aaa; }
      ul#chats { list-style:none; padding-left: 0; margin: 8px 0 0; max-height: 320px; overflow:auto; }
      ul#chats li { padding: 6px 4px; border-bottom: 1px solid #222; }
      mark { background:#333; color:#fff; padding:0 2px; border-radius:4px; }
    </style>
  </head>
  <body>
    <h1>Team Mini App</h1>

    <!-- Greeting + MOTD -->
    <div class="card">
      <p id="who"></p>
      <p id="motd" style="margin-top:8px"></p>
    </div>

    <!-- Chats with server-side search -->
    <div class="card">
      <div class="row">
        <button id="loadChats">Load chats</button>
        <input id="chatSearch" class="grow" placeholder="Search chats by title or idâ€¦" />
      </div>
      <ul id="chats"></ul>
    </div>

    <!-- Latest messages -->
    <div class="card">
      <h3>Latest messages</h3>
      <div class="row">
        <input id="chatIdMsgs" class="grow" placeholder="Enter chat_id (e.g., -1001234567890)" />
        <button id="loadMsgs">Load latest messages</button>
      </div>
      <pre id="msgs"></pre>
    </div>

    <!-- Summarize -->
    <div class="card">
      <h3>Summarize</h3>
      <div class="row">
        <input id="chatIdSum" class="grow" placeholder="Enter chat_id for summary" />
        <input id="sumLimit" style="width:140px" placeholder="How many msgs (e.g., 120)" />
        <button id="doSummary">Summarize</button>
      </div>
      <pre id="summaryOut"></pre>
    </div>

    <!-- Company details (auto + edit) -->
    <div class="card">
      <h3>Company details</h3>
      <div class="row">
        <input id="chatIdCompany" class="grow" placeholder="Enter chat_id for company details" />
        <button id="getCompany">Get company details</button>
        <button id="editCompany">Edit blurb</button>
      </div>
      <pre id="companyOut"></pre>
    </div>

    <!-- Status (auto + edit) -->
    <div class="card">
      <h3>Status</h3>
      <div class="row">
        <input id="chatIdStatus" class="grow" placeholder="Enter chat_id for status" />
        <button id="getStatus">Get status</button>
        <button id="editStatus">Edit status</button>
      </div>
      <pre id="statusOut"></pre>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      // Who opened the app
      const user = tg.initDataUnsafe?.user;
      document.getElementById('who').textContent =
        user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) â€” id: ${user.id}`
             : 'Open this from Telegram to see user info.';

      // Day-of-week MOTD
      function motd(name) {
        const day = new Date().toLocaleDateString(undefined, { weekday: 'long' });
        const map = {
          Monday:    "set the tone, plan, and think how you can get to the next step (level-up).",
          Tuesday:   "keep going! It's going greatâ€”knock out the smallest tasks and break big ones into small steps.",
          Wednesday: "take a break and breatheâ€”youâ€™re halfway through the week.",
          Thursday:  "take it easy but stay productive.",
          Friday:    "make a final push and then proudly enjoy your weekend ðŸŽ‰",
          Saturday:  "grab one tiny win and recharge.",
          Sunday:    "lightly prep for the week and enjoy some rest."
        };
        return `Hey ${name}, today is the perfect day to ${map[day] || 'make one meaningful step today.'}`;
      }
      document.getElementById('motd').textContent = motd(user?.first_name || 'there');

      // Main button
      tg.MainButton.setText('Close');
      tg.MainButton.onClick(() => tg.close());
      tg.MainButton.show();

      // Helpers
      const H = () => ({ 'x-telegram-init-data': tg.initData });
      const put = (id, t) => (document.getElementById(id).textContent = t);
      const err = (id, e) => put(id, `Error: ${e?.message || e}`);

      // --- CHATS + SERVER-SIDE SEARCH ---
      let lastSearch = '';
      function highlight(text, needle) {
        if (!needle) return text;
        const re = new RegExp(`(${needle.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'ig');
        return text.replace(re, '<mark>$1</mark>');
      }
      async function fetchChats(q = '') {
        const url = q ? `/api/chats?q=${encodeURIComponent(q)}` : '/api/chats';
        const res = await fetch(url, { headers: H() });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        return res.json();
      }
      async function renderChats(q = '') {
        try {
          lastSearch = q.trim();
          const chats = await fetchChats(lastSearch);
          const ul = document.getElementById('chats');
          ul.innerHTML = chats.map(c => {
            const title = c.title || '';
            const idStr = String(c.id);
            return `<li>${highlight(title, lastSearch)} <small class="mono">(${highlight(idStr, lastSearch)})</small></li>`;
          }).join('');
        } catch (e) { err('chats', e); }
      }
      document.getElementById('loadChats').onclick = () => renderChats('');
      document.getElementById('chatSearch').addEventListener('input', (e) => {
        renderChats(e.target.value);
      });

      // --- LATEST MESSAGES ---
      document.getElementById('loadMsgs').onclick = async () => {
        try {
          const id = document.getElementById('chatIdMsgs').value.trim();
          if (!id) return alert('Enter chat_id');
          const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const msgs = await res.json();
          put('msgs', msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n'));
        } catch (e) { err('msgs', e); }
      };

      // --- SUMMARY ---
      document.getElementById('doSummary').onclick = async () => {
        try {
          const id = document.getElementById('chatIdSum').value.trim();
          const lim = parseInt(document.getElementById('sumLimit').value.trim() || '120', 10);
          if (!id) return alert('Enter chat_id');
          const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=${lim}`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (data.text) put('summaryOut', data.text);
          else put('summaryOut', `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`);
        } catch (e) { err('summaryOut', e); }
      };

      // --- COMPANY DETAILS (AUTO + EDIT) ---
      document.getElementById('getCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          const res = await fetch(`/api/company-auto?chat_id=${encodeURIComponent(id)}`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          put('companyOut', data?.text || data?.blurb || data?.note || 'No blurb found.');
        } catch (e) { err('companyOut', e); }
      };

      document.getElementById('editCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          let current = '';
          try {
            const r0 = await fetch(`/api/blurb-get?chat_id=${encodeURIComponent(id)}`, { headers: H() });
            if (r0.ok) {
              const j0 = await r0.json();
              current = j0?.blurb || '';
            }
          } catch (_) {}
          const updated = prompt('Edit company blurb:', current);
          if (updated == null) return;
          const r = await fetch('/api/blurb-set', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...H() },
            body: JSON.stringify({ chat_id: id, blurb: updated })
          });
          const j = await r.json();
          if (!r.ok || !j.ok) throw new Error(j.error || 'save failed');
          put('companyOut', updated || '(empty)');
        } catch (e) { err('companyOut', e); }
      };

      // --- STATUS (AUTO + EDIT) ---
      const STATUS_LABELS = [
        'Talking stage','Awaiting SoW','SoW signed',
        'Preparing campaign','Campaign live','Awaiting report','Campaign finished'
      ];

      document.getElementById('getStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          const res = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          put('statusOut', data?.status || 'No status.');
        } catch (e) { err('statusOut', e); }
      };

      document.getElementById('editStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) return alert('Enter chat_id');
        const choice = prompt('Set status to one of:\n' + STATUS_LABELS.join('\n'), STATUS_LABELS[0]);
        if (!choice) return;
        if (!STATUS_LABELS.includes(choice)) return alert('Unknown status. Choose exactly from the list.');
        try {
          const r = await fetch('/api/status-set', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...H() },
            body: JSON.stringify({ chat_id: id, status: choice })
          });
          const j = await r.json();
          if (!r.ok || !j.ok) throw new Error(j.error || 'save failed');
          put('statusOut', `${choice} (manual)`);
        } catch (e) { err('statusOut', e); }
      };
    </script>
  </body>
</html>
