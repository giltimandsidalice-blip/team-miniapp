<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TRBE ‚Äî Team Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg-1:#0b0a0d; --bg-2:#131017;
    --text:#EDEAF5; --muted:#B9B4C8;
    --stroke:rgba(255,255,255,.12);
    --radius:16px; --radius-lg:18px;
    --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
    --accent-1:#b142b4; --accent-2:#c27bff;
    --glass:rgba(255,255,255,.06);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:"Manrope",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    background-attachment: fixed;
    background-image:
      radial-gradient(1200px 800px at 20% -10%, rgba(177,66,180,.22), transparent 60%),
      radial-gradient(1100px 700px at 90% 0%,   rgba(194,123,255,.18), transparent 55%),
      radial-gradient(1400px 900px at 80% 120%, rgba(177,66,180,.16), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-2));
    background-blend-mode: screen, screen, screen, normal;
    padding:18px 16px max(28px, calc(env(safe-area-inset-bottom) + 90px));
  }

  .wrap{max-width:1100px; margin:0 auto;}

  /* Hero */
  .hero{display:grid; gap:8px; margin:6px 0 18px; text-align:center;}
  .pill{
    display:inline-block; font-size:12px; color:var(--muted);
    border:1px solid var(--stroke); border-radius:999px; padding:6px 10px;
    backdrop-filter:blur(10px);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  }
  h1{font-size:clamp(28px,4.8vw,44px); line-height:1.05; margin:2px 0 0; font-weight:800; letter-spacing:-.5px}
  .gradient{background:linear-gradient(90deg, var(--accent-1), var(--accent-2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent}
  .motd{color:var(--muted); font-size:14px; margin-top:4px}

  /* Landing */
  .three-grid{display:grid; gap:14px; grid-template-columns:1fr; margin:16px 0 8px}
  @media (min-width:860px){ .three-grid{grid-template-columns:repeat(3,1fr)} }
  .tile{
    display:flex; gap:10px; align-items:center; justify-content:center;
    background:var(--glass); border:1px solid var(--stroke); border-radius:24px;
    box-shadow:var(--shadow); padding:26px; cursor:pointer; text-align:center;
    transition: transform .05s ease, filter .15s ease;
  }
  .tile:hover{ filter:brightness(1.06) } .tile:active{ transform:translateY(1px) }
  .tile h2{ margin:0; font-size:18px; font-weight:800 }

  /* Panels & cards */
  .panel{ display:none; margin-top:16px; position:relative }
  .back{
    position:absolute; right:10px; top:-6px;
    appearance:none; border:0; color:#fff; font-weight:800;
    padding:10px 12px; border-radius:12px; cursor:pointer;
    background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
    box-shadow:0 8px 20px rgba(177,66,180,.28), inset 0 1px 0 rgba(255,255,255,.12);
  }
  .card{
    background:var(--glass); border:1px solid var(--stroke); border-radius:var(--radius-lg);
    box-shadow:var(--shadow); padding:14px; margin-bottom:14px; backdrop-filter: blur(8px);
  }
  .card h3{font-size:16px; margin:0 0 10px; font-weight:800}
  .hint{color:var(--muted); font-size:12px}

  .toolbar{display:grid; gap:10px; grid-template-columns:1fr; margin-bottom:10px}
  @media (min-width:700px){ .toolbar{grid-template-columns: 1fr 260px} }

  input, textarea, select{
    width:100%; color:var(--text);
    background:rgba(255,255,255,.04); border:1px solid var(--stroke);
    border-radius:12px; padding:12px 14px; outline:none;
  }
  textarea{min-height:110px; resize:vertical}

  .btn{
    appearance:none; border:0; color:#fff; font-weight:800;
    padding:14px 16px; border-radius:16px; cursor:pointer;
    background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
    box-shadow:0 8px 20px rgba(177,66,180,.28), inset 0 1px 0 rgba(255,255,255,.12);
    transition:transform .05s ease, filter .15s ease; white-space:nowrap;
  }
  .btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
  .btn.secondary{
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color:var(--text);
  }
  .btn.mini{padding:9px 12px; font-size:13px; border-radius:12px}
  .btn:disabled{opacity:.6; filter:grayscale(40%)}

    /* Tasks */
  .task-list{list-style:none; padding:0; margin:8px 0 0; display:flex; flex-direction:column; gap:8px}
  .task-item{display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:rgba(255,255,255,.04)}
  .task-item.completed{opacity:.7}
  .task-item label{display:flex; gap:10px; width:100%; cursor:pointer}
  .task-item span{flex:1}
  .task-check{margin-top:2px; width:18px; height:18px; accent-color:var(--accent-2)}
  .task-meta{font-size:12px; color:var(--muted); margin-top:4px}
  .task-empty{padding:12px; border:1px dashed rgba(255,255,255,.12); border-radius:12px; color:var(--muted); text-align:center; font-size:13px}
  .assign-task-toolbar{margin-bottom:8px}
  .assign-task-side{display:grid; gap:8px}
  .assign-task-side .btn{width:100%}
  @media (min-width:700px){ .assign-task-toolbar{grid-template-columns:1fr 220px} }
    
  /* Chats list (dashboard) */
  .list{list-style:none; padding:0; margin:8px 0 0; border:1px solid var(--stroke); border-radius:12px; overflow:hidden}
  .row{
    display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03);
    cursor:pointer;
  }
  .row:hover{background:rgba(255,255,255,.07)}
  .row:last-child{border-bottom:0}
  .title{font-weight:700}
  .sub{font-size:12px; color:var(--muted)}
  .status-pill{
    padding:6px 10px; border-radius:999px;
    background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
    font-size:11px; font-weight:800; letter-spacing:.2px; justify-self:end;
  }

  pre.out{background:rgba(0,0,0,.35); border:1px solid var(--stroke); border-radius:12px; padding:12px; margin:10px 0 0; white-space:pre-wrap; max-height:280px; overflow:auto}
  .section-title{font-weight:800; margin:10px 0 8px}

  /* Timelines */
  .timeline{border:1px dashed rgba(255,255,255,.25); border-radius:12px; padding:12px; color:var(--muted)}
  .timeline .bar{height:12px; border-radius:999px; background:linear-gradient(90deg, var(--accent-1), var(--accent-2)); margin:8px 0 4px}

  /* Accordion */
  .acc{border:1px solid var(--stroke); border-radius:12px; overflow:hidden; margin-top:8px}
  .acc-item + .acc-item{border-top:1px solid var(--stroke)}
  .acc-head{display:flex; justify-content:space-between; align-items:center; padding:12px 14px; cursor:pointer; background:rgba(255,255,255,.04)}
  .acc-head h4{margin:0; font-size:16px}
  .acc-body{display:none; padding:12px 14px; background:rgba(255,255,255,.03)}
  .chev{transition:transform .15s ease}
  .acc-item.open .acc-body{display:block}
  .acc-item.open .chev{transform:rotate(180deg)}

  /* -------- Full-screen chooser (Select chats) -------- */
  .chooser-full{
    position:fixed; inset:0; z-index:3000;
    display:none; flex-direction:column; align-items:center;
    background:linear-gradient(180deg, #15111c, #0f0d14);
  }
  .chooser-full[aria-hidden="false"]{display:flex}

  .chooser-shell{
    width:min(900px, 98vw);
    height:min(96vh, 100%);
    margin:clamp(8px, 2vh, 18px) 0;
    background:#1b1623; border:1px solid var(--stroke); border-radius:20px;
    box-shadow:0 20px 40px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05);
    display:flex; flex-direction:column; overflow:hidden;
  }

  .chooser-top{
    position:sticky; top:0; z-index:1;
    display:grid; gap:10px; grid-template-columns:1fr 220px auto auto;
    padding:12px; background:#1b1623; border-bottom:1px solid var(--stroke);
  }
  .chooser-title{align-self:center; font-weight:800}
  .chooser-list{
    list-style:none; margin:0; padding:0;
    overflow:auto; flex:1; -webkit-overflow-scrolling:touch;
  }
  .chooser-row{
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
    padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02);
  }
  .chooser-row:hover{background:rgba(255,255,255,.06)}
  .chooser-row:last-child{border-bottom:0}
  .send-tick{ width:18px; height:18px; accent-color:#c27bff }

  /* Final confirm popup (unchanged) */
  .chooser-backdrop{
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(10,8,14,.85);  /* opaque-ish dark backdrop */
      z-index: 4000;
  }
  .chooser-card{
      width: min(720px, 96vw);
      background: #201a2a;                     /* solid background */
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(0,0,0,.6);
      padding: 14px;
      backdrop-filter: none;                    /* kill the blur */
  }

  /* Chips for selected chats */
  #sendChosenChips{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,.08); border:1px solid var(--stroke);
    font-size:12px;
  }
  .chip .x{
    display:inline-block; width:16px; height:16px; line-height:16px; text-align:center;
    border-radius:50%; background:rgba(255,255,255,.18); cursor:pointer; font-weight:800;
  }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <div class="hero">
      <span class="pill">TRBE Team Mini App</span>
      <h1>Get info without browsing chats. <span class="gradient">TRBE</span></h1>
      <div id="who" class="motd"></div>
      <div id="motd" class="motd"></div>
    </div>


    <!-- Landing: three boxes -->
    <div id="landing" class="three-grid">
      <div class="tile" data-open="panel-chats"><h2>Chats</h2></div>
      <div class="tile" data-open="panel-team"><h2>Team</h2></div>
      <div class="tile" data-open="panel-ai"><h2>AI Assistant</h2></div>
    </div>

    <!-- PANEL: CHATS -->
    <div id="panel-chats" class="panel">
      <button class="back" data-back>Back to Main</button>

      <!-- Dashboard -->
      <section class="card">
        <h3>Dashboard</h3>
        <div class="toolbar" style="grid-template-columns: 1fr 220px;">
          <input id="searchChats" placeholder="Search chats by title, @username, or id‚Ä¶" />
          <select id="statusFilter" title="Filter by status">
            <option value="">All statuses</option>
            <option>Talking</option><option>Awaiting data</option><option>Awaiting SoW</option>
            <option>SoW signed</option><option>Awaiting payment</option><option>Paid</option>
            <option>Data collection</option><option>Campaign launched</option><option>Report awaiting</option><option>Finished</option>
          </select>
        </div>
        <ul id="chats" class="list"></ul>
        <div class="hint">Tip: click a chat to auto-fill all tools below.</div>
      </section>

      <!-- Timelines -->
      <section class="card">
        <h3>Product launches (all projects)</h3>
        <div id="timelineProduct" class="timeline"><div class="bar"></div><div class="hint">Timeline placeholder ‚Äî product launch milestones will appear here.</div></div>
      </section>
      <section class="card">
        <h3>Campaign launches (all projects)</h3>
        <div id="timelineCampaign" class="timeline"><div class="bar"></div><div class="hint">Timeline placeholder ‚Äî campaign launch windows will appear here.</div></div>
      </section>

      <!-- Tools -->
      <section class="card">
        <h3>Tools</h3>

        <div class="acc" id="toolsAcc">
          <!-- 1) Summary -->
          <div class="acc-item">
            <div class="acc-head"><h4>1) Summarize</h4><span class="chev">‚ñæ</span></div>
            <div class="acc-body">
              <div class="toolbar" style="grid-template-columns:1fr 200px">
                <input id="chatIdSum" placeholder="Enter chat_id for summary" />
                <button class="btn" id="doSummary">Summarize</button>
              </div>
              <pre id="summaryOut" class="out">‚Äî</pre>
            </div>
          </div>

          <!-- 2) Status -->
          <div class="acc-item">
            <div class="acc-head"><h4>2) Status</h4><span class="chev">‚ñæ</span></div>
            <div class="acc-body">
              <div class="toolbar" style="grid-template-columns:1fr 1fr 1fr">
                <input id="chatIdStatus" placeholder="Enter chat_id for status" />
                <button class="btn" id="getStatus">Get status</button>
                <button class="btn secondary" id="editStatusBtn">Edit</button>
              </div>
              <div id="statusEditor" style="display:none; margin-bottom:10px">
                <select id="statusSel">
                  <option>Talking</option><option>Awaiting data</option><option>Awaiting SoW</option>
                  <option>SoW signed</option><option>Awaiting payment</option><option>Paid</option>
                  <option>Data collection</option><option>Campaign launched</option><option>Report awaiting</option><option>Finished</option>
                </select>
                <div class="toolbar" style="grid-template-columns:1fr 1fr">
                  <button class="btn" id="saveStatus">Save</button>
                  <button class="btn secondary" id="cancelStatus">Cancel</button>
                </div>
              </div>
              <pre id="statusOut" class="out">‚Äî</pre>
            </div>
          </div>

          <!-- 3) Company blurb -->
          <div class="acc-item">
            <div class="acc-head"><h4>3) Company blurb</h4><span class="chev">‚ñæ</span></div>
            <div class="acc-body">
              <div class="toolbar" style="grid-template-columns:1fr 200px">
                <input id="chatIdCompany" placeholder="Enter chat_id for blurb" />
                <button class="btn" id="getBlurb">Get blurb</button>
              </div>
              <pre id="blurbOut" class="out">‚Äî</pre>
            </div>
          </div>

          <!-- 4) Approx dates per chat -->
          <div class="acc-item">
            <div class="acc-head"><h4>4) Approximate dates (per chat)</h4><span class="chev">‚ñæ</span></div>
            <div class="acc-body">
              <div class="section-title" style="margin-top:4px">‚Ä¢ Product Launch</div>
              <div class="toolbar" style="grid-template-columns:1fr 200px">
                <input id="chatIdDatesProd" placeholder="Enter chat_id for product date" />
                <button class="btn" id="getDatesProd">Get product date</button>
              </div>
              <pre id="datesOutProd" class="out">Unknown</pre>
              <div class="section-title" style="margin-top:8px">‚Ä¢ Campaign Launch</div>
              <div class="toolbar" style="grid-template-columns:1fr 200px">
                <input id="chatIdDatesCamp" placeholder="Enter chat_id for campaign date" />
                <button class="btn" id="getDatesCamp">Get campaign date</button>
              </div>
              <pre id="datesOutCamp" class="out">Unknown</pre>
            </div>
          </div>

          <!-- 5) Next steps -->
          <div class="acc-item">
            <div class="acc-head"><h4>5) Next steps (AI)</h4><span class="chev">‚ñæ</span></div>
            <div class="acc-body">
              <div class="toolbar" style="grid-template-columns:1fr 200px">
                <input id="chatIdNext" placeholder="Enter chat_id for next steps" />
                <button class="btn" id="getNext">Suggest</button>
              </div>
              <pre id="nextOut" class="out">‚Äî</pre>
            </div>
          </div>
        </div>

        <!-- 6) Send a message -->
        <div class="acc-item">
          <div class="acc-head"><h4>6) Send a message</h4><span class="chev">‚ñæ</span></div>
          <div class="acc-body">
            <div class="toolbar" style="grid-template-columns:1fr 200px">
              <input id="sendChosenSummary" placeholder="No chats selected" disabled />
              <button class="btn" id="openSendChooser">Select chats</button>
            </div>

            <!-- Compose ABOVE chips -->
            <div id="sendCompose" style="display:none; margin-top:8px">
              <div class="toolbar" style="grid-template-columns:1fr 160px; margin:0 0 8px 0">
                <textarea id="sendText" placeholder="Type a message to send to all selected chats‚Ä¶"></textarea>
                <button class="btn" id="sendMessageBtn">Send message</button>
              </div>
              <div class="hint">Selected chats:</div>
              <div id="sendChosenChips" style="margin:6px 0 8px"></div>
            </div>

            <!-- Full-screen chooser -->
            <div id="sendChooserFull" class="chooser-full" aria-hidden="true" role="dialog" aria-modal="true">
              <div class="chooser-shell">
                <div class="chooser-top">
                  <div class="chooser-title">Select chats</div>
                  <input id="sendSearch" placeholder="Search by title, @username, or id‚Ä¶" />
                  <select id="sendStatusFilter">
                    <option value="">All statuses</option>
                    <option>Talking</option><option>Awaiting data</option><option>Awaiting SoW</option>
                    <option>SoW signed</option><option>Awaiting payment</option><option>Paid</option>
                    <option>Data collection</option><option>Campaign launched</option><option>Report awaiting</option><option>Finished</option>
                  </select>
                  <button class="btn secondary" id="cancelSendSelection">Cancel</button>
                  <button class="btn" id="confirmSendSelection" disabled>Confirm</button>
                </div>
                <ul id="sendChatsList" class="chooser-list"></ul>
                <div class="hint" style="padding:10px 12px; border-top:1px solid var(--stroke)">Tip: tick multiple chats, then press ‚ÄúConfirm‚Äù.</div>
              </div>
            </div>

            <!-- Final confirm popup -->
            <div id="sendConfirm" class="chooser-backdrop" aria-hidden="true">
              <div class="chooser-card">
                <h3 style="margin:0 0 8px 0">Confirm send</h3>
                <div class="hint" style="margin-bottom:8px">Are you sure you want to send this message to these chats?</div>
                <div class="section-title" style="margin:0 0 6px 0">Message preview</div>
                <pre id="sendConfirmMsg" class="out" style="max-height:140px"></pre>
                <div class="section-title" style="margin:8px 0 6px 0">Chats selected</div>
                <ul id="sendConfirmList" class="list"></ul>
                <div style="display:grid; gap:10px; grid-template-columns: 1fr 1fr; margin-top:10px">
                  <button class="btn secondary" id="sendConfirmCancel">Cancel</button>
                  <button class="btn" id="sendConfirmGo">Confirm send</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </div>

    <!-- PANEL: TEAM -->
    <div id="panel-team" class="panel">
      <button class="back" data-back>Back to Main</button>
      
      <section class="card" id="teamTasksCard">
        <h3>Team</h3>
        <div class="toolbar" style="grid-template-columns: 1fr 200px;">
          <input id="taskSearch" placeholder="Search tasks‚Ä¶" />
          <select id="teamSelect">
            <option value="">Choose a teammate‚Ä¶</option>
            <option value="@Shefer712">Arina ‚Äî @Shefer712</option>
            <option value="@Web3Reachout">Kate ‚Äî @Web3Reachout</option>
            <option value="@travalss">Val ‚Äî @travalss</option>
            <option value="@phoebemangoba">Phoebe ‚Äî @phoebemangoba</option>
          </select>
        </div>
                <div id="taskMessage" class="hint">Choose a teammate to see their tasks.</div>
        <ul id="taskList" class="task-list" aria-live="polite"></ul>
      </section>

      <section class="card" id="assignTaskCard">
        <h3>Assign a task</h3>
        <div class="toolbar assign-task-toolbar">
          <textarea id="newTaskText" placeholder="Describe the task‚Ä¶" rows="3"></textarea>
          <div class="assign-task-side">
            <select id="newTaskAssignee">
              <option value="">Assign to‚Ä¶</option>
              <option value="@Shefer712">Arina ‚Äî @Shefer712</option>
              <option value="@Web3Reachout">Kate ‚Äî @Web3Reachout</option>
              <option value="@travalss">Val ‚Äî @travalss</option>
              <option value="@phoebemangoba">Phoebe ‚Äî @phoebemangoba</option>
            </select>
            <button class="btn" id="addTaskBtn">Assign task</button>
          </div>
        </div>
        <div id="newTaskHint" class="hint">Tasks appear for the teammate you assign them to.</div>
      </section>

      <section class="card" id="completedTasksCard">
        <h3>See past tasks</h3>
        <div id="completedTasksMessage" class="hint">Choose a teammate to see their tasks.</div>
        <ul id="completedTaskList" class="task-list" aria-live="polite"></ul>
      </section>

      <button class="btn" id="createReportBtn" style="width:100%; margin-top:6px">Create a report</button>
    </div>

    <!-- PANEL: AI -->
    <div id="panel-ai" class="panel">
      <button class="back" data-back>Back to Main</button>
      <section class="card">
        <h3>AI Assistant</h3>
    
        <!-- Select chat -->
        <div class="toolbar" style="grid-template-columns: 1fr;">
          <select id="aiChatSelect">
            <option value="">Select a chat‚Ä¶</option>
          </select>
        </div>
    
        <!-- Prompt input -->
        <div class="toolbar" style="grid-template-columns: 1fr auto; margin-top:10px">
          <textarea id="aiPromptInput" placeholder="Ask your question based on the chat‚Ä¶"></textarea>
          <button class="btn" id="askAiBtn">Ask AI</button>
        </div>
    
        <!-- AI output -->
        <pre id="aiResult" class="out" style="margin-top:10px">Response will appear here‚Ä¶</pre>
      </section>
    </div>
  </div>

  <script>
    /* Telegram */
    const tg = window.Telegram?.WebApp; tg?.ready?.(); tg?.expand?.();
    const user = tg?.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) ‚Äî id: ${user.id}` : 'Open this from Telegram to see user info.';
    const day = new Date().getDay();
    const motdMap = {1:'Monday ‚Äî set the tone: plan the week and identify one ‚Äúlevel-up‚Äù step.',2:'Tuesday ‚Äî momentum day! Kill the smallest tasks and split big ones.',
      3:'Wednesday ‚Äî breathe, you‚Äôre half-way through. Review blockers.',4:'Thursday ‚Äî keep steady progress, stay productive without burning out.',
      5:'Friday ‚Äî final push, then enjoy the weekend. Tie loose ends.',0:'Sunday ‚Äî light planning beats heavy grinding. Prep your week.',6:'Saturday ‚Äî rest & reflect. Tiny wins only.'};
    document.getElementById('motd').textContent = motdMap[day] || '';
    tg?.MainButton?.setText?.('Close'); tg?.MainButton?.onClick?.(()=>tg.close()); tg?.MainButton?.show?.();

    /* Router */
    const landing = document.getElementById('landing');
    const panels = {'panel-chats': document.getElementById('panel-chats'),'panel-team':document.getElementById('panel-team'),'panel-ai':document.getElementById('panel-ai')};
    document.querySelectorAll('.tile').forEach(t=>{
      t.addEventListener('click', ()=>{
        const id = t.getAttribute('data-open');
        landing.style.display='none'; Object.values(panels).forEach(p=>p.style.display='none');
        panels[id].style.display='block';
        if (id === 'panel-chats') {
          loadChats();
          loadTimelines();
          } else if (id === 'panel-team') {
          hydrateTasksFromServer();
        } else if (id === 'panel-ai') {
          loadChats().then(populateAiChatSelect);
        }
      });
    });
    document.querySelectorAll('[data-back]').forEach(b=>{
      b.addEventListener('click', ()=>{
        Object.values(panels).forEach(p=>p.style.display='none'); landing.style.display='grid';
      });
    });

    /* Accordion */
    document.querySelectorAll('.acc-item .acc-head').forEach(h=>{
      h.addEventListener('click', ()=> h.parentElement.classList.toggle('open'));
    });

    /* Helpers */
    const H = {
      headers(){ return {'x-telegram-init-data': tg?.initData || ''}; },
      pickChat(id){
        ['chatIdSum','chatIdStatus','chatIdCompany','chatIdDatesProd','chatIdDatesCamp','chatIdNext'].forEach(k=>{
          const el=document.getElementById(k);
          if(el) el.value=id;
        });
        const aiSel = document.getElementById('aiChatSelect');
        if (aiSel) {
          const target = String(id);
          const hasOption = Array.from(aiSel.options || []).some(opt => opt.value === target);
          if (hasOption) {
            if (aiSel.value !== target) resetAiUi();
            aiSel.value = target;
          }
        }
      },
      fmtStatus(s){ return s || '‚Äî'; }
    };

    /* ---------- Send a message (Full-screen chooser) ---------- */
    const openSendChooser   = document.getElementById('openSendChooser');
    const sendChooserFull   = document.getElementById('sendChooserFull');
    const cancelSendSelBtn  = document.getElementById('cancelSendSelection');
    const confirmSendSelBtn = document.getElementById('confirmSendSelection');
    const sendSearch        = document.getElementById('sendSearch');
    const sendStatusFilter  = document.getElementById('sendStatusFilter');
    const sendChatsList     = document.getElementById('sendChatsList');

    const sendCompose       = document.getElementById('sendCompose');
    const sendChosenChips   = document.getElementById('sendChosenChips');
    const sendChosenSummary = document.getElementById('sendChosenSummary');

    let sendSelected = new Set(); // chat ids as strings
    let chatsCache = [];          // filled by loadChats()

    function openChooser(){
      // ensure chats are loaded
      (async ()=>{
        if (!Array.isArray(chatsCache) || chatsCache.length === 0) { await loadChats(); }
        renderSendList();
        confirmSendSelBtn.disabled = (sendSelected.size === 0);
        sendChooserFull.setAttribute('aria-hidden','false');
      })();
    }
    function closeChooser(){
      sendChooserFull.setAttribute('aria-hidden','true');
    }

    function renderSendList(){
      const q = (sendSearch.value||'').trim().toLowerCase();
      const f = (sendStatusFilter.value||'').trim();

      const items = (chatsCache||[]).filter(c=>{
        const matchesQ = !q || String(c.id).includes(q) ||
          (c.title||'').toLowerCase().includes(q) || (c.username||'').toLowerCase().includes(q);
        const matchesS = !f || (c.status === f);
        return matchesQ && matchesS;
      });

      if(!items.length){
        sendChatsList.innerHTML = `<li class="chooser-row"><div class="hint" style="grid-column:1/-1">No chats found.</div></li>`;
        return;
      }

      sendChatsList.innerHTML = items.map(c=>{
        const id = String(c.id);
        const checked = sendSelected.has(id) ? 'checked' : '';
        const uname = c.username ? `@${c.username}` : '';
        const status = c.status || '‚Äî';
        return `<li class="chooser-row" data-id="${id}">
          <input type="checkbox" class="send-tick" ${checked} />
          <div>
            <div class="title">${c.title || '(no title)'}</div>
            <div class="sub">${uname ? uname+' ‚Ä¢ ' : ''}${id}</div>
          </div>
          <div class="status-pill">${status}</div>
        </li>`;
      }).join('');

      sendChatsList.querySelectorAll('.chooser-row').forEach(li=>{
        const id = li.getAttribute('data-id');
        const tick = li.querySelector('.send-tick');
        tick.addEventListener('change', ()=>{
          if (tick.checked) sendSelected.add(id); else sendSelected.delete(id);
          confirmSendSelBtn.disabled = (sendSelected.size === 0);
          updateChosenSummaryPreview();
        });
        li.addEventListener('click', (e)=>{
          if (e.target === tick) return;
          tick.checked = !tick.checked; tick.dispatchEvent(new Event('change'));
        });
      });
    }

    function updateChosenSummaryPreview(){
      const count = sendSelected.size;
      sendChosenSummary.value = count ? `${count} chat${count>1?'s':''} selected` : 'No chats selected';
    }

    function showCompose(){
      const ids = Array.from(sendSelected);
      const map = new Map(chatsCache.map(c=>[String(c.id), c]));
      sendChosenChips.innerHTML = ids.map(id=>{
        const c = map.get(String(id)) || { title:'(unknown)', id };
        return `<span class="chip" data-id="${id}">
          ${c.title || '(no title)'} <span class="sub">‚Ä¢ ${id}</span>
          <span class="x" title="Remove">‚úï</span>
        </span>`;
      }).join('');

      sendChosenChips.querySelectorAll('.chip .x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const chip = x.closest('.chip'); const id = chip.getAttribute('data-id');
          sendSelected.delete(String(id)); chip.remove(); updateChosenSummaryPreview();
          if (sendSelected.size === 0){ sendCompose.style.display='none'; }
        });
      });

      sendCompose.style.display = ids.length ? 'block' : 'none';
      updateChosenSummaryPreview();
    }

    openSendChooser.addEventListener('click', openChooser);
    cancelSendSelBtn.addEventListener('click', closeChooser);
    confirmSendSelBtn.addEventListener('click', ()=>{ closeChooser(); showCompose(); });

    sendSearch.addEventListener('input', renderSendList);
    sendStatusFilter.addEventListener('change', renderSendList);

    /* Send ‚Üí final confirm popup */
    const sendMessageBtn   = document.getElementById('sendMessageBtn');
    const sendConfirm      = document.getElementById('sendConfirm');
    const sendConfirmMsg   = document.getElementById('sendConfirmMsg');
    const sendConfirmList  = document.getElementById('sendConfirmList');
    const sendConfirmCancel= document.getElementById('sendConfirmCancel');
    const sendConfirmGo    = document.getElementById('sendConfirmGo');

    function openFinalConfirm(){
      const msg = (document.getElementById('sendText').value || '').trim();
      const ids = Array.from(sendSelected);
      if (!ids.length){ alert('Select at least one chat first.'); return; }
      if (!msg){ alert('Write a message first.'); return; }
      sendConfirmMsg.textContent = msg;

      const map = new Map(chatsCache.map(c=>[String(c.id), c]));
      sendConfirmList.innerHTML = ids.map(id=>{
        const c = map.get(String(id)) || { title:'(unknown)', id, status:'‚Äî' };
        const uname = c.username ? `@${c.username}` : '';
        const status = c.status || '‚Äî';
        return `<li class="row">
          <div>
            <div class="title">${c.title || '(no title)'}</div>
            <div class="sub">${uname ? uname+' ‚Ä¢ ' : ''}${id}</div>
          </div>
          <div class="status-pill">${status}</div>
        </li>`;
      }).join('');
      sendConfirm.style.display = 'flex';
    }
    function closeFinalConfirm(){ sendConfirm.style.display = 'none'; }

    sendMessageBtn?.addEventListener('click', openFinalConfirm);
    sendConfirmCancel?.addEventListener('click', closeFinalConfirm);
sendConfirmGo?.addEventListener('click', async ()=>{
  const msg = (document.getElementById('sendText').value || '').trim();
  const ids = Array.from(sendSelected);
  if (!ids.length) { alert('Select at least one chat first.'); return; }
  if (!msg) { alert('Write a message first.'); return; }

  try{
    const r = await fetch('/api/send-message', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...H.headers(), // adds x-telegram-init-data for backend auth
      },
      body: JSON.stringify({
        chat_ids: ids,
        message: msg,
        parse_mode: 'HTML',
        disable_notification: false,
        preview_only: false
      })
    });

    const raw = await r.text();
    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      console.error('Non-JSON error body from server:', raw);
      alert(`Send failed (${r.status}): ${raw.slice(0,300)}`);
      return;
    }

    if (!r.ok) {
      console.error('send-message failed', r.status, data);
      alert(`Send failed (${r.status}): ${data?.message || data?.error || 'Unknown error'}`);
      return;
    }

    const sent = data?.sent ?? 0;
    const failed = data?.failed ?? 0;

    // Close popup and give feedback
    closeFinalConfirm();

    if (failed > 0) {
      // Show per-chat errors in console to help debugging
      console.warn('Some chats failed:', data?.results?.filter(x=>x.status!=='ok'));
      alert(`Sent to ${sent} chat${sent!==1?'s':''}; failed ${failed}. Check console for details.`);
    } else {
      alert(`Successfully sent to ${sent} chat${sent!==1?'s':''}.`);
    }

    // (Optional) Clear the message box after successful send
    // document.getElementById('sendText').value = '';

  } catch (e){
    console.error('send-message network error', e);
    alert(`Network error: ${e?.message || e}`);
  }
});
    
    // üîç Live search and status filter handlers
    document.getElementById('searchChats').addEventListener('input', renderChats);
    document.getElementById('statusFilter').addEventListener('change', renderChats);

        /* ---------- Chats dashboard & data ---------- */

    const chatsList = document.getElementById('chats');

    async function loadChats(){
      chatsList.innerHTML = `<li class="row"><div>Loading‚Ä¶</div></li>`;
      try{
        const r = await fetch('/api/chats', { headers:H.headers() });
        const data = await r.json().catch(()=>null);
        if(!r.ok){ chatsList.innerHTML = `<li class="row"><div>Server error (${r.status}): ${(data&&data.error)||'unknown'}</div></li>`; chatsCache = []; return; }
        chatsCache = (data||[]).map(c => ({...c, status:'‚Äî', status_updated_at:null}));
        renderChats();
        await batchLoadStatuses(chatsCache.slice(0, 50).map(c=>c.id));
      }catch(e){
        chatsList.innerHTML = `<li class="row"><div>Network/JS error: ${e.message||e}</div></li>`; chatsCache = [];
      }
    }

    function daysSince(dateStr){
      if(!dateStr) return null;
      const then = new Date(dateStr); if(isNaN(then)) return null;
      const d = Math.floor((Date.now() - then.getTime()) / (1000*60*60*24));
      return d>=0 ? `${d}d` : null;
    }

    function renderChats(){
      const q = document.getElementById('searchChats').value.trim().toLowerCase();
      const f = document.getElementById('statusFilter').value;
      const items = chatsCache.filter(c=>{
        const matchesQ = !q || String(c.id).includes(q) ||
          (c.title||'').toLowerCase().includes(q) || (c.username||'').toLowerCase().includes(q);
        const matchesS = !f || (c.status===f);
        return matchesQ && matchesS;
      });

      if(!items.length){ chatsList.innerHTML = `<li class="row"><div>No chats.</div></li>`; return; }

      chatsList.innerHTML = items.map(c => {
        const uname = c.username ? `@${c.username}` : '';
        const badge = (() => {
          let txt = H.fmtStatus(c.status);
          if (c.status === 'SoW signed') { const d = daysSince(c.status_updated_at); if (d) txt += ` ¬∑ ${d}`; }
          return txt;
        })();
        return `<li class="row" data-id="${c.id}">
          <div>
            <div class="title">${c.title || '(no title)'}</div>
            <div class="sub">${uname ? uname+' ‚Ä¢ ' : ''}${c.id}</div>
          </div>
          <div class="status-pill">${badge}</div>
        </li>`;
      }).join('');

      chatsList.querySelectorAll('.row').forEach(li=>{
        li.addEventListener('click', async ()=>{
          const id = li.getAttribute('data-id');
          H.pickChat(id);
          chatsList.querySelectorAll('.row').forEach(x=>x.style.outline='none');
          li.style.outline='2px solid rgba(194,123,255,.6)';
          await fetchAndApplyStatus(id, li.querySelector('.status-pill'));
        });
      });
    }

    async function fetchAndApplyStatus(chatId, badgeEl){
      try{
        const r = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(chatId)}&limit=300`, { headers:H.headers() });
        const data = await r.json().catch(()=>({}));
        if(!r.ok) return;
        const s = data?.status || data?.text || '‚Äî';
        const updated_at = data?.status_updated_at || null;

        const idx = chatsCache.findIndex(x=>String(x.id)===String(chatId));
        if(idx>=0){ chatsCache[idx].status = s; chatsCache[idx].status_updated_at = updated_at; }

        if (badgeEl){
          let txt = s;
          if (s==='SoW signed'){ const d = daysSince(updated_at); if (d) txt += ` ¬∑ ${d}`; }
          badgeEl.textContent = txt;
        }
      }catch(_){}
    }

    async function batchLoadStatuses(ids){
      for (const id of ids){
        const badge = document.querySelector(`.row[data-id="${id}"] .status-pill`);
        await fetchAndApplyStatus(id, badge);
      }
    }

    /* Timelines */
    async function loadTimelines(){
      const tp = document.getElementById('timelineProduct');
      const tc = document.getElementById('timelineCampaign');
      const setLoading = (el, msg) => { el.innerHTML = `<div class="bar"></div><div class="hint">${msg}</div>`; };
      setLoading(tp, 'Loading‚Ä¶'); setLoading(tc, 'Loading‚Ä¶');
      try{
        const [rp, rc] = await Promise.all([
          fetch('/api/timeline-product',  { headers:H.headers() }),
          fetch('/api/timeline-campaign', { headers:H.headers() })
        ]);
        const jp = await rp.json().catch(()=>({})); const jc = await rc.json().catch(()=>({}));
        const render = (el, ok, payload) => {
          if (!ok) { el.innerHTML = `<div class="bar"></div><div class="hint">Error: ${(payload&&payload.error)||'server error'}</div>`; return; }
          const items = payload.items || [];
          if (!items.length){ el.innerHTML = `<div class="bar"></div><div class="hint">No mentions found.</div>`; return; }
          el.innerHTML = `<div class="bar"></div><ul style="margin:6px 0 0; padding-left:16px">${items.map(i=>`<li>${i.label}</li>`).join('')}</ul>`;
        };
        render(tp, rp.ok, jp); render(tc, rc.ok, jc);
      }catch(e){
        tp.innerHTML = `<div class="bar"></div><div class="hint">Error: ${e.message||e}</div>`;
        tc.innerHTML = `<div class="bar"></div><div class="hint">Error: ${e.message||e}</div>`;
      }
    }

    /* SUMMARY */
    document.getElementById('doSummary').onclick = async () => {
      const id = document.getElementById('chatIdSum').value.trim();
      if (!id) return alert('Enter chat_id');
      const out = document.getElementById('summaryOut');
      out.textContent = 'Summarizing‚Ä¶';
      try {
        const r = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}`, { headers: { 'x-telegram-init-data': window.Telegram?.WebApp?.initData || '' }});
        const data = await r.json().catch(()=>({}));
        if (!r.ok) { out.textContent = `Server error (${r.status}): ${data?.error || 'Unknown error'}${data?.stage ? ` [${data.stage}]` : ''}`; return; }
        out.textContent = data.text || '(no text)';
      } catch (e) { out.textContent = `Network/JS error: ${e.message || e}`; }
    };

    /* STATUS ‚Äî auto */
    document.getElementById('getStatus').onclick = async ()=>{
      const id=document.getElementById('chatIdStatus').value.trim();
      if(!id) return alert('Enter chat_id');
      const out=document.getElementById('statusOut'); out.textContent='Loading‚Ä¶';
      try{
        const r=await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers:H.headers() });
        const data=await r.json().catch(()=>({}));
        if(!r.ok){ out.textContent=`Server error (${r.status}): ${data?.error||'unknown'}`; return; }
        const s = data?.status || data?.text || '‚Äî'; out.textContent = s;
        const idx = chatsCache.findIndex(x=>String(x.id)===String(id));
        if(idx>=0){ chatsCache[idx].status = s; const row = document.querySelector(`.row[data-id="${id}"] .status-pill`); if(row) row.textContent = s; }
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
    };

    /* STATUS ‚Äî manual edit/save */
    const editBtn = document.getElementById('editStatusBtn');
    const statusEditor = document.getElementById('statusEditor');
    const statusSel = document.getElementById('statusSel');
    document.getElementById('cancelStatus').onclick = ()=>{ statusEditor.style.display='none'; };
    editBtn.onclick = ()=>{ statusEditor.style.display = statusEditor.style.display==='none' ? 'block' : 'none'; };
    document.getElementById('saveStatus').onclick = async ()=>{
      const id=document.getElementById('chatIdStatus').value.trim();
      if(!id) return alert('Enter chat_id');
      const status = statusSel.value;
      const out=document.getElementById('statusOut'); out.textContent='Saving‚Ä¶';
      try{
        const r=await fetch('/api/status', { method:'POST', headers:{'Content-Type':'application/json', ...H.headers()}, body:JSON.stringify({ chat_id:id, status }) });
        const txt = await r.text();
        if(!r.ok){ out.textContent = `Server error (${r.status}): ${txt||'unknown'}`; return; }
        out.textContent = status;
        const idx = chatsCache.findIndex(x=>String(x.id)===String(id));
        if(idx>=0){ chatsCache[idx].status = status; const row = document.querySelector(`.row[data-id="${id}"] .status-pill`); if(row) row.textContent = status; }
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
      finally{ statusEditor.style.display='none'; }
    };

    /* BLURB */
    document.getElementById('getBlurb').onclick = async ()=>{
      const id=document.getElementById('chatIdCompany').value.trim();
      if(!id) return alert('Enter chat_id');
      const out=document.getElementById('blurbOut'); out.textContent='Loading‚Ä¶';
      try{
        const r=await fetch(`/api/company-blurb?chat_id=${encodeURIComponent(id)}`, { headers:H.headers() });
        const data=await r.json().catch(()=>({}));
        if(!r.ok){ out.textContent=`Server error (${r.status}): ${data?.error||'unknown'}`; return; }
        out.textContent = data.text || data.blurb || data.note || 'No blurb found.';
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
    };

    /* PER-CHAT DATES */
    document.getElementById('getDatesProd').onclick = async ()=>{
      const id=document.getElementById('chatIdDatesProd').value.trim();
      if(!id) return alert('Enter chat_id');
      const out=document.getElementById('datesOutProd'); out.textContent='Loading‚Ä¶';
      try{
        const r=await fetch(`/api/date-product?chat_id=${encodeURIComponent(id)}`, { headers:H.headers() });
        const data=await r.json().catch(()=>({}));
        if(!r.ok){ out.textContent=`Server error (${r.status}): ${data?.error||'unknown'}`; return; }
        out.textContent = data?.text || data?.month || data?.label || 'Unknown';
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
    };
    document.getElementById('getDatesCamp').onclick = async ()=>{
      const id=document.getElementById('chatIdDatesCamp').value.trim();
      if(!id) return alert('Enter chat_id');
      const out=document.getElementById('datesOutCamp'); out.textContent='Loading‚Ä¶';
      try{
        const r=await fetch(`/api/date-campaign?chat_id=${encodeURIComponent(id)}`, { headers:H.headers() });
        const data=await r.json().catch(()=>({}));
        if(!r.ok){ out.textContent=`Server error (${r.status}): ${data?.error||'unknown'}`; return; }
        out.textContent = data?.text || data?.month || data?.label || 'Unknown';
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
    };

    /* NEXT STEPS (AI) */
    document.getElementById('getNext').onclick = async ()=>{
      const id = document.getElementById('chatIdNext').value.trim();
      if (!id) return alert('Enter chat_id');
      const out = document.getElementById('nextOut'); out.textContent = 'Thinking‚Ä¶';
      try{
        const r = await fetch(`/api/next-steps?chat_id=${encodeURIComponent(id)}&limit=120`, { headers: { 'x-telegram-init-data': window.Telegram?.WebApp?.initData || '' }});
        const data = await r.json().catch(()=>({}));
        if (!r.ok) { out.textContent = `Server error (${r.status}): ${data?.error||'unknown'}${data?.stage?` [${data.stage}]`:''}`; return; }
        out.textContent = data.text || '(no suggestions)';
      }catch(e){ out.textContent = `Error: ${e.message||e}`; }
    };

        /* Team tasks */
    const teamSelectEl = document.getElementById('teamSelect');
    const taskSearchEl = document.getElementById('taskSearch');
    const taskListEl = document.getElementById('taskList');
    const completedListEl = document.getElementById('completedTaskList');
    const taskMessageEl = document.getElementById('taskMessage');
    const completedMessageEl = document.getElementById('completedTasksMessage');
    const newTaskTextEl = document.getElementById('newTaskText');
    const newTaskAssigneeEl = document.getElementById('newTaskAssignee');
    const addTaskBtnEl = document.getElementById('addTaskBtn');
    const newTaskHintEl = document.getElementById('newTaskHint');
    const defaultNewTaskHint = 'Tasks appear for the teammate you assign them to.';

    const teamTasks = {};
    let isHydratingTasks = false;

    function normalizeHandle(handle = ''){
      return String(handle || '').trim().replace(/^@/, '');
    }

    const teammateDirectory = (() => {
      const meta = {};
      const options = document.querySelectorAll('#teamSelect option, #newTaskAssignee option');
      options.forEach(opt => {
        const raw = (opt?.value || '').trim();
        if(!raw) return;
        const username = normalizeHandle(raw);
        if(!username) return;
        const key = username.toLowerCase();
        if(!meta[key]) meta[key] = { username, user_id: null, value: raw };
        if(!meta[key].value) meta[key].value = raw;
        const userIdAttr = opt.getAttribute('data-user-id');
        if(userIdAttr && meta[key].user_id == null){
          const parsed = Number(userIdAttr);
          if(Number.isSafeInteger(parsed)){
            meta[key].user_id = parsed;
          }
        }
      });
      return meta;
    })();

    function ensureTaskMetadata(task, fallbackHandle = ''){
      if(!task) return task;

      if(!task.text && task.description){
        task.text = task.description;
      }

      const derivedHandle = task.username || task.assignee || task.handle || fallbackHandle;
      const normalized = normalizeHandle(derivedHandle);
      if(normalized){
        task.username = normalized;
      }

      if(task.user_id != null){
        const parsedId = Number(task.user_id);
        task.user_id = Number.isSafeInteger(parsedId) ? parsedId : null;
      }

      if(task.user_id == null && normalized){
        const directoryEntry = teammateDirectory[normalized.toLowerCase()];
        if(directoryEntry && directoryEntry.user_id != null){
          task.user_id = directoryEntry.user_id;
        }
      }

      return task;
    }

    function teammateOptionValue(handle = ''){
      const normalized = normalizeHandle(handle);
      if(!normalized) return '';
      const directoryEntry = teammateDirectory[normalized.toLowerCase()];
      if(directoryEntry?.value) return directoryEntry.value;
      const options = document.querySelectorAll('#teamSelect option, #newTaskAssignee option');
      for(const opt of options){
        if(normalizeHandle(opt?.value || '') === normalized){
          return opt.value;
        }
      }
      return handle && handle.startsWith('@') ? handle : `@${normalized}`;
    }

    async function logTaskCompletion(task, teammateHandle = ''){
      const enriched = ensureTaskMetadata(task, teammateHandle);
      if(!enriched) return;

      const normalizedUserId = (typeof enriched.user_id === 'number' && Number.isSafeInteger(enriched.user_id)) ? enriched.user_id : null;
      const payload = {
        tg_username: normalizeHandle(enriched.username),
        tg_user_id: normalizedUserId,
        description: enriched.text || ''
      };

      if(!payload.tg_username || !payload.description){
        console.warn('Skipping task log ‚Äî incomplete payload', payload);
        return;
      }

      try {
        const response = await fetch('/api/log-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if(!response.ok){
          const errBody = await response.text().catch(()=> '');
          console.warn('log-task request failed', response.status, errBody);
        }
      } catch (error) {
        console.error('log-task network error', error);
      }
    }

      async function notifyTaskAssignment(assigneeHandle, taskText, taskId){
      const handle = (assigneeHandle || '').trim();
      const text = (taskText || '').trim();
      if(!handle || !text){
        return { ok:false, error:'INVALID_INPUT', message:'Missing handle or task text.' };
      }

      try{
        if(!Array.isArray(chatsCache) || !chatsCache.length){
          await loadChats();
        }
      }catch(e){
        console.warn('Failed to load chats before notifying:', e);
      }

      const normalizedHandle = handle.replace(/^@/, '').toLowerCase();
      const chat = (chatsCache || []).find(c => (c.username || '').toLowerCase() === normalizedHandle);

      if(!chat){
        const msg = `No chat found for ${handle}.`;
        console.warn(msg);
        return { ok:false, error:'NO_CHAT', message: msg };
      }

      const assignerName = user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : '';
      const assignerHandle = user?.username ? `@${user.username}` : '';
      const assigneeLabel = optionLabelFor(handle) || chat.title || handle;

      try{
        const r = await fetch('/api/task-notify', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            ...H.headers()
          },
          body: JSON.stringify({
            assignee_chat_id: chat.id,
            assignee_username: chat.username ? `@${chat.username}` : handle,
            assignee_display: assigneeLabel,
            task_text: text,
            task_id: taskId,
            assigner_name: assignerName,
            assigner_username: assignerHandle
          })
        });

        const data = await r.json().catch(()=>({}));
        if(!r.ok){
          console.warn('Task notify failed', r.status, data);
          return { ok:false, error:data?.error || 'SERVER_ERROR', message:data?.message || 'Failed to send notification.' };
        }

        return { ok:true, result:data?.result || null };
      }catch(e){
        console.error('Task notify network error', e);
        return { ok:false, error:'NETWORK_ERROR', message:e?.message || String(e) };
      }
    }
    
    function ensureTeamBucket(id){
      if(!id) return null;
      if(!teamTasks[id]) teamTasks[id] = { active: [], completed: [] };
      return teamTasks[id];
    }

    function escapeHtml(str = ''){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDateTime(iso){
      if(!iso) return '';
      const dt = new Date(iso);
      if(Number.isNaN(dt.getTime())) return '';
      return dt.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function optionLabelFor(value){
      const opts = document.querySelectorAll('#teamSelect option, #newTaskAssignee option');
      for(const opt of opts){
        if(opt.value === value) return opt.textContent.trim();
      }
      return value;
    }

    async function hydrateTasksFromServer(teammateHandle = ''){
      if(isHydratingTasks) return;
      isHydratingTasks = true;
      try{
        const normalized = normalizeHandle(teammateHandle);
        const query = normalized ? `?username=${encodeURIComponent(normalized)}` : '';
        const response = await fetch(`/api/team-tasks${query}`);
        const data = await response.json().catch(()=>({}));
        if(!response.ok){
          console.warn('Failed to load tasks from server', response.status, data);
          return;
        }

        Object.keys(teamTasks).forEach(key => delete teamTasks[key]);

        const pushRow = (collection, row) => {
          if(!row) return;
          const handle = row.tg_username || row.username || row.handle || '';
          const optionValue = teammateOptionValue(handle);
          if(!optionValue) return;
          const bucket = ensureTeamBucket(optionValue);
          const baseId = row.id ?? row.task_id ?? row.taskId ?? row.uuid ?? `${collection}-${Date.now()}-${Math.random()}`;
          const taskId = collection === 'completed' ? `c-${baseId}` : String(baseId);
          const createdAt = row.created_at || row.createdAt || row.assigned_at || null;
          const completedAt = row.completed_at || row.completedAt || null;
          const task = ensureTaskMetadata({
            id: taskId,
            text: row.description || row.text || '',
            username: row.tg_username || row.username || handle,
            user_id: row.tg_user_id ?? row.user_id ?? null,
            createdAt,
            completedAt
          }, optionValue);
          task.serverId = row.id ?? row.task_id ?? row.taskId ?? null;
          if(collection === 'completed' && !task.completedAt){
            task.completedAt = completedAt || createdAt || task.completedAt || null;
          }
          if(!task.createdAt){
            task.createdAt = createdAt || task.completedAt || null;
          }
          bucket[collection].push(task);
        };

        (Array.isArray(data.active) ? data.active : []).forEach(row => pushRow('active', row));
        (Array.isArray(data.completed) ? data.completed : []).forEach(row => pushRow('completed', row));

        Object.values(teamTasks).forEach(bucket => {
          bucket.active.sort((a, b) => {
            const aTime = new Date(a.createdAt || a.completedAt || 0).getTime();
            const bTime = new Date(b.createdAt || b.completedAt || 0).getTime();
            return bTime - aTime;
          });
          bucket.completed.sort((a, b) => {
            const aTime = new Date(a.completedAt || a.createdAt || 0).getTime();
            const bTime = new Date(b.completedAt || b.createdAt || 0).getTime();
            return bTime - aTime;
          });
        });

        if(teamSelectEl && teamSelectEl.value && !teamTasks[teamSelectEl.value]){
          ensureTeamBucket(teamSelectEl.value);
        }

        renderTasks();
      }catch(e){
        console.error('Failed to hydrate tasks from server', e);
      }finally{
        isHydratingTasks = false;
      }
    }

    function renderTasks(){
      if(!taskListEl || !completedListEl) return;
      const teammate = teamSelectEl?.value || '';
      const query = (taskSearchEl?.value || '').trim().toLowerCase();

      taskListEl.innerHTML = '';
      completedListEl.innerHTML = '';

      if(taskMessageEl){
        taskMessageEl.textContent = 'Choose a teammate to see their tasks.';
        taskMessageEl.style.display = teammate ? 'none' : 'block';
      }
      if(completedMessageEl){
        completedMessageEl.textContent = 'Choose a teammate to see their tasks.';
        completedMessageEl.style.display = teammate ? 'none' : 'block';
      }

      if(!teammate) return;

      const bucket = ensureTeamBucket(teammate);
      const activeWithMeta = bucket.active.map(task => ensureTaskMetadata(task, teammate));
      const completedWithMeta = bucket.completed.map(task => ensureTaskMetadata(task, teammate));
      const filteredActive = activeWithMeta.filter(task => !query || (task.text || '').toLowerCase().includes(query));
      const filteredCompleted = completedWithMeta.filter(task => !query || (task.text || '').toLowerCase().includes(query));

      if(!filteredActive.length){
        taskListEl.innerHTML = `<li class="task-empty">${query ? 'No tasks match your search.' : 'No tasks yet ‚Äî assign one below.'}</li>`;
      } else {
        taskListEl.innerHTML = filteredActive.map(task => `<li class="task-item"><label><input type="checkbox" class="task-check" data-task-id="${task.id}" /><span>${escapeHtml(task.text)}</span></label></li>`).join('');
      }

      if(!filteredCompleted.length){
        completedListEl.innerHTML = `<li class="task-empty">${query ? 'No completed tasks match your search.' : 'No completed tasks yet.'}</li>`;
      } else {
        completedListEl.innerHTML = filteredCompleted.map(task => `<li class="task-item completed"><div><div>${escapeHtml(task.text)}</div><div class="task-meta">Completed ${formatDateTime(task.completedAt)}</div></div></li>`).join('');
      }

      taskListEl.querySelectorAll('.task-check').forEach(box => {
        box.addEventListener('change', (event) => {
          if(!event.target.checked) return;
          const id = event.target.getAttribute('data-task-id');
          completeTask(teammate, id);
        });
      });
    }

    async function persistTaskAssignment(task, teammateHandle = ''){
      const enriched = ensureTaskMetadata({ ...task }, teammateHandle);
      const payload = {
        tg_username: normalizeHandle(enriched?.username || teammateHandle),
        tg_user_id: (typeof enriched?.user_id === 'number' && Number.isSafeInteger(enriched.user_id)) ? enriched.user_id : null,
        description: enriched?.text || ''
      };

      if(!payload.tg_username || !payload.description){
        return { ok:false, error:'Missing username or description.' };
      }

      try{
        const response = await fetch('/api/team-tasks', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json().catch(()=>({}));
        if(!response.ok){
          const reason = data?.error || data?.message || `Server error (${response.status})`;
          console.warn('Failed to persist task', response.status, data);
          return { ok:false, error:reason };
        }

        const saved = data?.task || null;
        if(saved){
          task.id = String(saved.id ?? task.id);
          task.serverId = saved.id ?? task.serverId ?? null;
          task.username = saved.tg_username || task.username;
          task.user_id = saved.tg_user_id ?? task.user_id ?? null;
          task.text = saved.description || task.text;
          task.createdAt = saved.created_at || task.createdAt || new Date().toISOString();
          ensureTaskMetadata(task, teammateHandle);
          renderTasks();
        }

        return { ok:true, task:saved };
      }catch(e){
        console.error('persistTaskAssignment error', e);
        return { ok:false, error:e?.message || String(e) };
      }
    }

    async function syncTaskCompletion(task){
      const rawId = task?.serverId ?? task?.id;
      const numericId = Number(rawId);
      if(!Number.isSafeInteger(numericId)) return;
      try{
        const response = await fetch('/api/team-tasks', {
          method:'DELETE',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ id: numericId })
        });
        if(!response.ok){
          const text = await response.text().catch(()=> '');
          console.warn('Failed to remove task from server', response.status, text);
        }
      }catch(e){
        console.error('syncTaskCompletion error', e);
      }
    }

    async function completeTask(teammate, id){
      const bucket = ensureTeamBucket(teammate);
      if(!bucket) return;
      const idx = bucket.active.findIndex(task => String(task.id) === String(id));
      if(idx === -1) return;
      const [task] = bucket.active.splice(idx, 1);
      task.completedAt = new Date().toISOString();
      const completedTask = ensureTaskMetadata(task, teammate);
      bucket.completed.unshift(completedTask);
      renderTasks();
      await Promise.allSettled([
        logTaskCompletion(completedTask, teammate),
        syncTaskCompletion(completedTask)
      ]);
      hydrateTasksFromServer(teammate);
    }

    async function handleAssignTask(){
      if(!newTaskTextEl) return;
      const text = newTaskTextEl.value.trim();
      const assignee = (newTaskAssigneeEl?.value || teamSelectEl?.value || '').trim();

      if(!text){
        if(newTaskHintEl) newTaskHintEl.textContent = 'Please describe the task before assigning it.';
        return;
      }
      if(!assignee){
        if(newTaskHintEl) newTaskHintEl.textContent = 'Please choose who should take this task.';
        return;
      }

      const label = optionLabelFor(assignee);
      const bucket = ensureTeamBucket(assignee);
      const tempId = `temp-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      const nowIso = new Date().toISOString();
      const task = ensureTaskMetadata({ id: tempId, text, createdAt: nowIso, username: assignee }, assignee);
      task.serverId = task.serverId ?? null;
      bucket.active.unshift(task);
      if(teamSelectEl && teamSelectEl.value === assignee){
        renderTasks();
      }

      if(newTaskHintEl) newTaskHintEl.textContent = `Task assigned to ${label}. Saving‚Ä¶`;

      const saveResult = await persistTaskAssignment(task, assignee);
      if(!saveResult?.ok){
        const reason = String(saveResult?.error || 'Task could not be saved.');
        const idx = bucket.active.indexOf(task);
        if(idx !== -1){
          bucket.active.splice(idx, 1);
        }
        if(teamSelectEl && teamSelectEl.value === assignee){
          renderTasks();
        }
        if(newTaskHintEl) newTaskHintEl.textContent = `Task not saved: ${reason}`;
        return;
      }


      newTaskTextEl.value = '';
      if(newTaskAssigneeEl) newTaskAssigneeEl.value = assignee;

      if(newTaskHintEl) newTaskHintEl.textContent = `Task assigned to ${label}. Sending notification‚Ä¶`;
      if(teamSelectEl && teamSelectEl.value === assignee){
        renderTasks();
      }

      const notifyPromise = notifyTaskAssignment(assignee, task.text, task.id);
      if(newTaskHintEl){
        const result = await notifyPromise;
        if(result?.ok){
          newTaskHintEl.textContent = `Task assigned to ${label}. Notification sent.`;
        }else{
          const reason = result?.message || result?.error || 'Notification failed.';
          newTaskHintEl.textContent = `Task assigned to ${label}. ${reason}`;
        }
      }else{
        await notifyPromise;
      }
      hydrateTasksFromServer(assignee);
    }

    if(addTaskBtnEl) addTaskBtnEl.addEventListener('click', handleAssignTask);
    if(taskSearchEl) taskSearchEl.addEventListener('input', ()=>renderTasks());
    if(teamSelectEl) teamSelectEl.addEventListener('change', ()=>{
      if(taskSearchEl) taskSearchEl.value = '';
      if(newTaskAssigneeEl){
        newTaskAssigneeEl.value = teamSelectEl.value || '';
      }
      renderTasks();
      if(newTaskHintEl) newTaskHintEl.textContent = defaultNewTaskHint;
    });
    if(newTaskTextEl) newTaskTextEl.addEventListener('input', ()=>{
      if(newTaskHintEl) newTaskHintEl.textContent = defaultNewTaskHint;
    });
    if(newTaskAssigneeEl) newTaskAssigneeEl.addEventListener('change', ()=>{
      if(newTaskHintEl) newTaskHintEl.textContent = defaultNewTaskHint;
    });
    if(newTaskAssigneeEl && teamSelectEl){
      newTaskAssigneeEl.value = teamSelectEl.value || '';
    }
    if(newTaskHintEl) newTaskHintEl.textContent = defaultNewTaskHint;
    renderTasks();
    hydrateTasksFromServer();
    
    /* AI Assistant */
    const aiChatSelect = document.getElementById('aiChatSelect');
    const aiPromptInput = document.getElementById('aiPromptInput');
    const aiResult = document.getElementById('aiResult');
    const askAiBtn = document.getElementById('askAiBtn');
    const defaultAiResultText = 'Response will appear here‚Ä¶';

    function resetAiUi(){
      if (aiPromptInput) aiPromptInput.value = '';
      if (aiResult) aiResult.textContent = defaultAiResultText;
      if (askAiBtn) askAiBtn.disabled = false;
    }

    function populateAiChatSelect(){
      if (!aiChatSelect) return;
      const previous = aiChatSelect.value;
      aiChatSelect.innerHTML = '<option value="">Select a chat‚Ä¶</option>';
      (chatsCache || []).forEach(chat => {
        const parts = [chat.title || '(no title)'];
        if (chat.username) parts.push(`@${chat.username}`);
        parts.push(chat.id);
        aiChatSelect.innerHTML += `<option value="${chat.id}">${parts.join(' ‚Ä¢ ')}</option>`;
      });
      if (previous) {
        const hasPrev = Array.from(aiChatSelect.options).some(opt => opt.value === previous);
        if (hasPrev) aiChatSelect.value = previous;
      }
    }
    
    async function handleAskAi(){
      const chatId = aiChatSelect?.value || '';
      const prompt = aiPromptInput?.value.trim() || '';
      if (!chatId) return alert('Please select a chat');
      if (!prompt) return alert('Please enter a question or prompt');

      if (aiResult) aiResult.textContent = 'Thinking‚Ä¶';
      if (askAiBtn) askAiBtn.disabled = true;
      
      try {
        const r = await fetch('/api/ask-ai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-telegram-init-data': window.Telegram?.WebApp?.initData || ''
          },
          body: JSON.stringify({ chat_id: chatId, prompt })
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
                   if (aiResult) aiResult.textContent = `Error (${r.status}): ${data?.error || 'Unknown error'}`;
        } else {
          if (aiResult) aiResult.textContent = data?.text || '(No response)';
        }
      } catch (e) {
        if (aiResult) aiResult.textContent = `Error: ${e?.message || e || 'Unknown error'}`;
      } finally {
        if (askAiBtn) askAiBtn.disabled = false;
      }
    }
  
    if (askAiBtn) askAiBtn.addEventListener('click', handleAskAi);
    if (aiChatSelect) {
      aiChatSelect.addEventListener('change', resetAiUi);
    }
  </script>
</body>
</html>
