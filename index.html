<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Telegram Web Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #fff; background: #000; }
      .card { border: 1px solid #444; border-radius: 12px; padding: 16px; margin-top: 12px; }
      pre { white-space: pre-wrap; }
      input { padding: 8px; border-radius: 8px; border: 1px solid #555; background:#111; color:#fff; }
      button { padding: 8px 12px; border-radius: 12px; border: 1px solid #666; background:#222; color:#fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <h1>Team Mini App</h1>

    <div class="card">
      <p id="who"></p>
      <button id="hello">Ping backend</button>
      <pre id="out"></pre>
    </div>

    <div class="card">
      <button id="loadChats">Load chats</button>
      <ul id="chats"></ul>
    </div>

    <div class="card">
      <input id="chatId" placeholder="Enter chat_id (e.g., -1001234567890)" />
      <button id="loadMsgs">Load latest messages</button>
      <pre id="msgs"></pre>
    </div>

    <div class="card">
      <input id="chatIdSum" placeholder="Enter chat_id for summary" />
      <input id="sumLimit" placeholder="How many msgs (e.g., 120)" />
      <button id="doSummary">Summarize</button>
      <pre id="summaryOut"></pre>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      // Show who opened the app (works only inside Telegram)
      const user = tg.initDataUnsafe?.user;
      document.getElementById('who').textContent =
        user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) â€” id: ${user.id}`
             : 'Open this from Telegram to see user info.';

      // Telegram main button
      tg.MainButton.setText('Close');
      tg.MainButton.onClick(() => tg.close());
      tg.MainButton.show();

      // Helper to show errors in specific <pre> blocks
      function showError(where, err) {
        const box = document.getElementById(where);
        if (box) box.textContent = `Error: ${err?.message || err}`;
      }

      // Ping backend
      document.getElementById('hello').onclick = async () => {
        try {
          const res = await fetch('/api/hello', {
            headers: { 'x-telegram-init-data': tg.initData }
          });
          const text = await res.text();
          document.getElementById('out').textContent = text;
        } catch (e) {
          showError('out', e);
        }
      };

      // Load chats
      document.getElementById('loadChats').onclick = async () => {
        try {
          const res = await fetch('/api/chats', {
            headers: { 'x-telegram-init-data': tg.initData }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const chats = await res.json();
          document.getElementById('chats').innerHTML =
            chats.map(c => `<li>${c.title} <small>(${c.id})</small></li>`).join('');
        } catch (e) {
          showError('out', e);
        }
      };

      // Load latest messages for one chat
      document.getElementById('loadMsgs').onclick = async () => {
        try {
          const id = document.getElementById('chatId').value.trim();
          if (!id) { alert('Enter chat_id'); return; }
          const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, {
            headers: { 'x-telegram-init-data': tg.initData }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const msgs = await res.json();
          document.getElementById('msgs').textContent =
            msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n');
        } catch (e) {
          showError('msgs', e);
        }
      };

      // Summarize last N messages
      document.getElementById('doSummary').onclick = async () => {
        try {
          const id = document.getElementById('chatIdSum').value.trim();
          const lim = parseInt(document.getElementById('sumLimit').value.trim() || '120', 10);
          if (!id) { alert('Enter chat_id'); return; }
          const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=${lim}`, {
            headers: { 'x-telegram-init-data': tg.initData }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (data.text) {
            document.getElementById('summaryOut').textContent = data.text;
          } else {
            document.getElementById('summaryOut').textContent =
              `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`;
          }
        } catch (e) {
          showError('summaryOut', e);
        }
      };
    </script>
  </body>
</html>
