<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Telegram Web Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #fff; background: #000; }
      .card { border: 1px solid #444; border-radius: 12px; padding: 16px; margin-top: 12px; }
      pre { white-space: pre-wrap; }
      input, textarea, select { padding: 8px; border-radius: 8px; border: 1px solid #555; background:#111; color:#fff; }
      button { padding: 8px 12px; border-radius: 12px; border: 1px solid #666; background:#222; color:#fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
      .grow { flex:1 1 240px; }
      h3 { margin: 0 0 8px 0; }
      small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color:#aaa; }
    </style>
  </head>
  <body>
    <h1>Team Mini App</h1>

    <!-- Greeting + MOTD -->
    <div class="card">
      <p id="who"></p>
      <p id="motd" style="margin-top:8px"></p>
    </div>

    <!-- Chats list -->
    <div class="card">
      <div class="row">
        <button id="loadChats">Load chats</button>
        <small class="mono">Use a chat_id from the list below in other tools</small>
      </div>
      <ul id="chats"></ul>
    </div>

    <!-- Latest messages -->
    <div class="card">
      <h3>Latest messages</h3>
      <div class="row">
        <input id="chatIdMsgs" class="grow" placeholder="Enter chat_id (e.g., -1001234567890)" />
        <button id="loadMsgs">Load latest messages</button>
      </div>
      <pre id="msgs"></pre>
    </div>

    <!-- Summarize -->
    <div class="card">
      <h3>Summarize</h3>
      <div class="row">
        <input id="chatIdSum" class="grow" placeholder="Enter chat_id for summary" />
        <input id="sumLimit" style="width:140px" placeholder="How many msgs (e.g., 120)" />
        <button id="doSummary">Summarize</button>
      </div>
      <pre id="summaryOut"></pre>
    </div>

    <!-- Company details (blurb) with Edit -->
    <div class="card">
      <h3>Company details</h3>
      <div class="row">
        <input id="chatIdCompany" class="grow" placeholder="Enter chat_id for company details" />
        <button id="getCompany">Get company details</button>
        <button id="editCompany">Edit blurb</button>
      </div>
      <pre id="companyOut"></pre>
    </div>

    <!-- Status with Edit -->
    <div class="card">
      <h3>Status</h3>
      <div class="row">
        <input id="chatIdStatus" class="grow" placeholder="Enter chat_id for status" />
        <button id="getStatus">Get status</button>
        <button id="editStatus">Edit status</button>
      </div>
      <pre id="statusOut"></pre>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      // Who opened the app (works only inside Telegram)
      const user = tg.initDataUnsafe?.user;
      document.getElementById('who').textContent =
        user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) â€” id: ${user.id}`
             : 'Open this from Telegram to see user info.';

      // Day-of-week message
      function motd(name) {
        const day = new Date().toLocaleDateString(undefined, { weekday: 'long' });
        const map = {
          Monday:    "set the tone, plan, and think how you can get to the next step (level-up).",
          Tuesday:   "keep going! It's going greatâ€”knock out the smallest tasks and break big ones into small steps.",
          Wednesday: "take a break and breatheâ€”youâ€™re halfway through the week.",
          Thursday:  "take it easy but stay productive.",
          Friday:    "make a final push and then proudly enjoy your weekend ðŸŽ‰",
          Saturday:  "grab one tiny win and recharge.",
          Sunday:    "lightly prep for the week and enjoy some rest."
        };
        const line = map[day] || "make one meaningful step today.";
        return `Hey ${name}, today is the perfect day to ${line}`;
      }
      document.getElementById('motd').textContent = motd(user?.first_name || 'there');

      // Telegram main button
      tg.MainButton.setText('Close');
      tg.MainButton.onClick(() => tg.close());
      tg.MainButton.show();

      // Helpers
      function showError(where, err) {
        const box = document.getElementById(where);
        if (box) box.textContent = `Error: ${err?.message || err}`;
      }
      function headers() {
        return { 'x-telegram-init-data': tg.initData };
      }

      // Load chats
      document.getElementById('loadChats').onclick = async () => {
        try {
          const res = await fetch('/api/chats', { headers: headers() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const chats = await res.json();
          document.getElementById('chats').innerHTML =
            chats.map(c => `<li>${c.title} <small class="mono">(${c.id})</small></li>`).join('');
        } catch (e) {
          showError('chats', e);
        }
      };

      // Load latest messages for one chat
      document.getElementById('loadMsgs').onclick = async () => {
        try {
          const id = document.getElementById('chatIdMsgs').value.trim();
          if (!id) { alert('Enter chat_id'); return; }
          const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, { headers: headers() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const msgs = await res.json();
          document.getElementById('msgs').textContent =
            msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n');
        } catch (e) {
          showError('msgs', e);
        }
      };

      // Summarize last N messages
      document.getElementById('doSummary').onclick = async () => {
        try {
          const id = document.getElementById('chatIdSum').value.trim();
          const lim = parseInt(document.getElementById('sumLimit').value.trim() || '120', 10);
          if (!id) { alert('Enter chat_id'); return; }
          const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=${lim}`, { headers: headers() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (data.text) {
            document.getElementById('summaryOut').textContent = data.text;
          } else {
            document.getElementById('summaryOut').textContent =
              `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`;
          }
        } catch (e) {
          showError('summaryOut', e);
        }
      };

      // --- Company details (auto + edit) ---
      document.getElementById('getCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) { alert('Enter chat_id'); return; }
        try {
          const res = await fetch(`/api/company-auto?chat_id=${encodeURIComponent(id)}`, { headers: headers() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          document.getElementById('companyOut').textContent =
            data?.text ? data.text : (data?.note || 'No blurb found.');
        } catch (e) {
          showError('companyOut', e);
        }
      };

      document.getElementById('editCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) { alert('Enter chat_id'); return; }
        // Get current blurb first (if exists)
        try {
          let current = '';
          try {
            const r0 = await fetch(`/api/company?chat_id=${encodeURIComponent(id)}`, { headers: headers() });
            if (r0.ok) current = await r0.text();
          } catch (_) {}
          const updated = prompt('Edit company blurb:', (current || '').trim());
          if (updated == null) return; // cancelled
          const r = await fetch('/api/company', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...headers() },
            body: JSON.stringify({ chat_id: id, blurb: updated.trim() })
          });
          const txt = await r.text();
          document.getElementById('companyOut').textContent = txt;
        } catch (e) {
          showError('companyOut', e);
        }
      };

      // --- Status (auto + edit) ---
      const STATUS_LABELS = [
        'Talking stage',
        'Awaiting SoW',
        'SoW signed',
        'Preparing campaign',
        'Campaign live',
        'Awaiting report',
        'Campaign finished'
      ];

      document.getElementById('getStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) { alert('Enter chat_id'); return; }
        try {
          const res = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers: headers() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          document.getElementById('statusOut').textContent =
            data?.status ? data.status : 'No status.';
        } catch (e) {
          showError('statusOut', e);
        }
      };

      document.getElementById('editStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) { alert('Enter chat_id'); return; }

        // Simple chooser via prompt. (Optional: replace with a modal/select UI)
        const choice = prompt(
          'Set status to one of:\n' + STATUS_LABELS.join('\n'),
          STATUS_LABELS[0]
        );
        if (!choice) return;
        if (!STATUS_LABELS.includes(choice)) {
          alert('Unknown status. Please choose exactly one from the list.');
          return;
        }

        try {
          const res = await fetch('/api/status', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...headers() },
            body: JSON.stringify({ chat_id: id, status: choice })
          });
          const txt = await res.text();
          document.getElementById('statusOut').textContent = txt;
        } catch (e) {
          showError('statusOut', e);
        }
      };
    </script>
  </body>
</html>
