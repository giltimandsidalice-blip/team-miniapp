<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Telegram Web Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      :root{
        --bg-top:#000000;
        --bg-bottom:#b142b4;      /* TRBE gradient tail */
        --text:#ffffff;
        --muted:#b4a9c9;
        --card:#141218cc;         /* semi-transparent panel */
        --card-border:#b142b480;  /* soft purple edge */
        --accent:#b142b4;
        --accent-2:#8b5cf6;       /* slight violet for rings/shadows */
        --btn:#2a2730;
        --btn-hover:#332f3b;
        --ring:#3f2a52;
        --radius:16px;
      }

      /* Page */
      html,body{
        height:100%;
        margin:0;
      }
      body{
        color:var(--text);
        background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
        -webkit-font-smoothing:antialiased;
        display:flex;
        align-items:flex-start;
        justify-content:center;
      }

      .container{
        width:100%;
        max-width:860px;
        padding:24px 16px 120px;
        text-align:center;                 /* CENTER content */
      }

      /* TRBE header with three dots */
      .brand{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:12px;
        margin-bottom:8px;
        user-select:none;
      }
      .brand .word{
        font-weight:800;
        letter-spacing:.02em;
        font-size:28px;
      }
      .brand .dots{
        display:inline-flex; gap:8px; align-items:center;
      }
      .brand .dot{
        width:14px; height:14px; border-radius:999px;
        background: radial-gradient(100% 100% at 30% 20%, #ff7adf 0%, #b142b4 65%, #6b2a87 100%);
        box-shadow:0 0 12px #b142b480, inset 0 0 6px #ffffff10;
      }
      .brand .dot:nth-child(1){ transform:translateY(-2px) scale(1.15); }
      .brand .dot:nth-child(2){ transform:translateY(2px)  scale(.9); }
      .brand .dot:nth-child(3){ transform:translateY(-1px) scale(.75); }

      /* Headings & text */
      h1{
        margin:4px 0 2px;
        font-weight:800;
        letter-spacing:.02em;
        font-size:32px;
      }
      .hello{
        margin-top:6px;
        font-size:16px;
        color:var(--text);
        font-weight:700;
      }
      .motd{
        margin-top:6px;
        font-size:14px;            /* smaller than hello line */
        color:var(--muted);
      }

      /* Cards */
      .card{
        margin:18px auto 0;
        padding:18px;
        background:var(--card);
        border:1px solid var(--card-border);
        border-radius:var(--radius);
        box-shadow: 0 6px 30px #00000055, inset 0 0 0 1px #ffffff08;
        backdrop-filter: blur(6px);
      }
      .card h3{
        margin:0 0 12px;
        font-size:18px;
        font-weight:800;          /* bold, not transparent */
        letter-spacing:.01em;
      }

      /* Controls */
      .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
      input, textarea, select{
        width:100%;
        max-width:520px;
        color:var(--text);
        background:#0f0d12;
        border:1px solid #2c2637;
        border-radius:12px;
        padding:10px 12px;
        outline:none;
        box-shadow: inset 0 0 0 1px #ffffff08;
      }
      textarea{ min-height:84px; resize:vertical; }

      .btn{
        display:inline-flex; align-items:center; justify-content:center;
        gap:8px;
        min-width:180px;                    /* bigger button */
        font-weight:800;                    /* bold text */
        padding:12px 16px;
        color:#fff;
        background:linear-gradient(180deg,#2b2440,#1d182a);
        border:1px solid #4b3a62;
        border-radius:14px;
        cursor:pointer;
        transition:transform .05s ease, background .2s ease, box-shadow .2s ease;
        box-shadow:
          0 10px 24px #00000070,
          inset 0 0 0 1px #ffffff0e,
          0 0 0 3px transparent;
      }
      .btn:hover{ background:linear-gradient(180deg,#352d50,#241e36); }
      .btn:active{ transform:translateY(1px); }
      .btn.primary{
        background: radial-gradient(120% 140% at 30% 0%, #b142b4 0%, #6b2a87 65%, #2b1640 100%);
        border-color:#a05acb;
        box-shadow:
          0 18px 36px #b142b455,
          inset 0 0 0 1px #ffffff14;
      }
      .btn.primary:hover{
        background: radial-gradient(120% 140% at 30% 0%, #c754c5 0%, #7a33a1 60%, #331a4e 100%);
      }

      /* Lists */
      .list{
        margin:12px auto 0;
        max-width:640px;
        max-height:260px;
        overflow:auto;
        padding:0 8px;
        text-align:left;              /* better readability for long titles */
      }
      .list li{
        list-style:none;
        padding:8px 10px;
        margin:6px 0;
        background:#0f0d12;
        border:1px solid #2b2235;
        border-radius:10px;
        color:#e8defc;
      }
      .muted{ color:var(--muted); }
      pre{
        text-align:left;
        margin:12px auto 0;
        max-width:720px;
        background:#0f0d12;
        border:1px solid #2b2235;
        border-radius:12px;
        padding:12px;
        white-space:pre-wrap;
      }

      /* Small helpers */
      .stack-sm{ display:flex; flex-direction:column; gap:10px; align-items:center; }
      .stack-md{ display:flex; flex-direction:column; gap:14px; align-items:center; }
      .w320{ max-width:320px; width:100%; }
      .w520{ max-width:520px; width:100%; }
      .w640{ max-width:640px; width:100%; }
      .pill{
        display:inline-block; padding:4px 10px; border-radius:999px;
        background:#201a29; border:1px solid #3a2b4c; color:#c9b9eb; font-size:12px;
      }
    </style>
  </head>

  <body>
    <div class="container">

      <!-- TRBE header -->
      <div class="brand">
        <div class="word">TRBE</div>
        <div class="dots" aria-hidden="true">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>
      <h1>Team Mini App</h1>

      <!-- Greeting -->
      <div class="card">
        <div class="hello" id="helloLine">Hello!</div>
        <div class="motd" id="motd">Loading a tiny nudge for the day…</div>
      </div>

      <!-- Load chats (with search) -->
      <div class="card">
        <h3>Chats</h3>
        <div class="stack-sm w640">
          <div class="row w640">
            <input id="chatSearch" class="w520" placeholder="Search by chat title…" />
            <button id="loadChats" class="btn primary">Load chats</button>
          </div>
          <div class="muted">Tip: search after loading to filter locally.</div>
        </div>
        <ul id="chats" class="list"></ul>
        <pre id="chatsOut" class="w640" style="display:none"></pre>
      </div>

      <!-- Messages -->
      <div class="card">
        <h3>Load latest messages</h3>
        <div class="row w640">
          <input id="chatId" class="w320" placeholder="Enter chat_id (e.g., -100…)" />
          <button id="loadMsgs" class="btn">Load latest</button>
        </div>
        <pre id="msgs" class="w640"></pre>
      </div>

      <!-- Summary -->
      <div class="card">
        <h3>Summarize</h3>
        <div class="row w640">
          <input id="chatIdSum" class="w320" placeholder="chat_id to summarize" />
          <input id="sumLimit" class="w320" placeholder="How many messages (e.g., 120)" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="doSummary" class="btn primary">Summarize</button>
        </div>
        <pre id="summaryOut" class="w640"></pre>
      </div>

      <!-- Company details -->
      <div class="card">
        <h3>Company details</h3>
        <div class="row w640">
          <input id="chatIdCompany" class="w320" placeholder="chat_id for company details" />
          <button id="getCompany" class="btn">Get company details</button>
          <button id="editCompany" class="btn">Edit</button>
        </div>
        <pre id="companyOut" class="w640"></pre>
      </div>

      <!-- Status -->
      <div class="card">
        <h3>Status</h3>
        <div class="row w640">
          <input id="chatIdStatus" class="w320" placeholder="chat_id for status" />
          <button id="getStatus" class="btn">Get status</button>
          <button id="editStatus" class="btn">Edit</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Labels: <span class="pill">Talking stage</span>
          <span class="pill">Awaiting SoW</span>
          <span class="pill">SoW signed</span>
          <span class="pill">Preparing campaign</span>
          <span class="pill">Campaign live</span>
          <span class="pill">Awaiting report</span>
          <span class="pill">Campaign finished</span>
        </div>
        <pre id="statusOut" class="w640"></pre>
      </div>

    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      /* ————— Header text ————— */
      const user = tg.initDataUnsafe?.user;
      const helloLine = document.getElementById('helloLine');
      if (user) {
        helloLine.textContent = `Hello, ${user.first_name} (@${user.username || 'no username'}) — id: ${user.id}`;
      } else {
        helloLine.textContent = 'Open this from Telegram to see user info.';
      }

      /* ————— MOTD (day-of-week nudge) ————— */
      (function setMotd(){
        const lines = {
          0: "Week reset soon — reflect, recharge, and plan one light win.",
          1: "Set the tone. Pick a lever that moves the week forward.",
          2: "Great momentum — crush tiny tasks and break big ones small.",
          3: "Halfway there. Breathe, tidy the board, trim distractions.",
          4: "Smooth & steady. Keep it productive, keep it light.",
          5: "Final push — ship one thing and enjoy your weekend!",
          6: "Light maintenance day. Organize, draft, and rest."
        };
        const motd = document.getElementById('motd');
        const d = new Date().getDay();
        motd.textContent = lines[d];
      })();

      /* ————— Helpers ————— */
      function show(whereId, text, display = true){
        const el = document.getElementById(whereId);
        if (!el) return;
        el.textContent = text;
        el.style.display = display ? 'block' : 'none';
      }
      function errText(e){ return e?.message || e || 'Unknown error'; }
      function authHeaders(){
        return { 'x-telegram-init-data': window.Telegram.WebApp.initData };
      }

      /* ————— Chats with search ————— */
      let cachedChats = [];   // keep the list for client-side filtering

      async function loadChats(){
        const outId = 'chatsOut';
        show(outId, '', false);
        try{
          const res = await fetch('/api/chats', { headers: authHeaders() });
          if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const chats = await res.json();
          cachedChats = Array.isArray(chats) ? chats : [];
          renderChats(cachedChats);
        }catch(e){
          show(outId, `Error: ${errText(e)}`);
        }
      }

      function renderChats(list){
        const ul = document.getElementById('chats');
        ul.innerHTML = (list||[]).map(c =>
          `<li><strong>${escapeHtml(c.title || 'Untitled')}</strong> <span class="muted">(${c.id})</span></li>`
        ).join('') || `<li class="muted">No chats found.</li>`;
      }

      function filterChats(){
        const q = (document.getElementById('chatSearch').value || '').toLowerCase().trim();
        if(!q){ renderChats(cachedChats); return; }
        const filtered = cachedChats.filter(c => String(c.title||'').toLowerCase().includes(q));
        renderChats(filtered);
      }

      /* ————— Messages ————— */
      async function loadLatest(){
        const id = document.getElementById('chatId').value.trim();
        if(!id) return alert('Enter chat_id');
        try{
          const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, { headers: authHeaders() });
          if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const msgs = await res.json();
          const text = (msgs||[]).map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n');
          show('msgs', text || 'No messages.');
        }catch(e){
          show('msgs', `Error: ${errText(e)}`);
        }
      }

      /* ————— Summary ————— */
      async function summarize(){
        const id  = document.getElementById('chatIdSum').value.trim();
        const lim = parseInt(document.getElementById('sumLimit').value.trim() || '120', 10);
        if(!id) return alert('Enter chat_id');
        try{
          const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=${lim}`, { headers: authHeaders() });
          if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (data.text){
            show('summaryOut', data.text);
          } else {
            const t = `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`;
            show('summaryOut', t);
          }
        }catch(e){
          show('summaryOut', `Error: ${errText(e)}`);
        }
      }

      /* ————— Company details (read only here; Edit is UI-only for now) ————— */
      async function getCompany(){
        const id = document.getElementById('chatIdCompany').value.trim();
        if(!id) return alert('Enter chat_id');
        try{
          const res = await fetch(`/api/company-auto?chat_id=${encodeURIComponent(id)}`, { headers: authHeaders() });
          if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          show('companyOut', data?.text || 'No blurb found.');
        }catch(e){
          show('companyOut', `Error: ${errText(e)}`);
        }
      }

      /* “Edit” buttons are placeholders here (no POST wiring yet) */
      function editCompany(){ alert('Edit Company: we’ll wire this to POST /api/company later.'); }
      function editStatus(){  alert('Edit Status: we’ll wire this to POST /api/status later.'); }

      /* ————— Status (auto) ————— */
      async function getStatus(){
        const id = document.getElementById('chatIdStatus').value.trim();
        if(!id) return alert('Enter chat_id');
        try{
          const res = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers: authHeaders() });
          if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          show('statusOut', data?.status ? `Status: ${data.status}\nSamples used: ${data.samples_used}` : 'No status.');
        }catch(e){
          show('statusOut', `Error: ${errText(e)}`);
        }
      }

      /* ————— Wire up UI ————— */
      document.getElementById('loadChats').onclick = loadChats;
      document.getElementById('chatSearch').oninput = filterChats;

      document.getElementById('loadMsgs').onclick = loadLatest;
      document.getElementById('doSummary').onclick = summarize;

      document.getElementById('getCompany').onclick = getCompany;
      document.getElementById('editCompany').onclick  = editCompany;

      document.getElementById('getStatus').onclick = getStatus;
      document.getElementById('editStatus').onclick  = editStatus;

      /* ————— Small util ————— */
      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }
    </script>
  </body>
</html>
