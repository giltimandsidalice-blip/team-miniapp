<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* ===== THEME TOKENS (tweak these to match trbe.me) ===== */
  :root {
    --bg: #0b0b0f;             /* page background */
    --card: #121218;           /* card background */
    --card-glass: rgba(18,18,24,.6);
    --border: #262633;
    --text: #eef1f5;
    --muted: #9aa3b2;

    --primary: #6ae1ff;        /* accent 1 */
    --primary-600: #39cfff;
    --secondary: #b48cff;      /* accent 2 (optional) */
    --danger: #ff6b6b;

    --radius: 14px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);

    --font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
  }

  @media (prefers-color-scheme: light) {
    :root {
      --bg: #fbfbfe;
      --card: #ffffff;
      --card-glass: rgba(255,255,255,.7);
      --border: #e8e8ef;
      --text: #0e1016;
      --muted: #5b6270;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
  }

  /* Respect Telegram theme if available */
  body.tg-light { --bg:#fff; --card:#fff; --border:#e9e9ef; --text:#111319; --muted:#69707e; }
  body.tg-dark  { --bg:#0b0b0f; --card:#121218; --border:#232333; --text:#eef1f5; --muted:#9aa3b2; }

  /* ===== BASE ===== */
  html, body { height:100%; }
  body {
    font-family: var(--font);
    background: radial-gradient(1200px 800px at 10% -10%, rgba(106,225,255,.08), transparent 40%),
                radial-gradient(1000px 700px at 110% 10%, rgba(180,140,255,.08), transparent 45%),
                var(--bg);
    color: var(--text);
    margin: 0; padding: 20px;
  }
  h1 { margin: 0 0 8px; font-size: 22px; letter-spacing:.2px; }
  h3 { margin: 0 0 10px; font-size: 15px; color: var(--muted); font-weight: 600; }

  /* ===== CARD ===== */
  .card {
    background: linear-gradient(180deg, var(--card-glass), var(--card));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    margin-top: 14px;
    transition: transform .15s ease, border-color .2s ease, background .2s ease;
  }
  .card:hover { transform: translateY(-1px); border-color: rgba(106,225,255,.35); }

  /* ===== LAYOUT HELPERS ===== */
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .grow { flex:1 1 260px; }

  /* ===== INPUTS ===== */
  input, textarea, select {
    width: 100%;
    background: #0f1116;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    outline: none;
    transition: border-color .15s ease, box-shadow .15s ease;
  }
  input::placeholder, textarea::placeholder { color: #727b8b; }
  input:focus, textarea:focus, select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(106,225,255,.15);
  }

  /* ===== BUTTONS ===== */
  .btn {
    appearance:none;
    border: 1px solid var(--border);
    background: #141827;
    color: var(--text);
    border-radius: 12px;
    padding: 10px 14px;
    cursor: pointer;
    transition: transform .08s ease, border-color .15s ease, background .15s ease;
  }
  .btn:hover { border-color: rgba(106,225,255,.35); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn[disabled] { opacity:.6; cursor:not-allowed; }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-600));
    color: #001016;
    border: none;
  }
  .btn-outline { background: transparent; }
  .btn-danger { background: linear-gradient(135deg, #ff8585, var(--danger)); border:none; }

  /* ===== CHAT LIST ===== */
  ul#chats { list-style:none; padding:0; margin:10px 0 0; max-height: 340px; overflow:auto; }
  ul#chats li {
    display:flex; justify-content:space-between; align-items:center;
    padding: 10px 8px; border-bottom: 1px dashed rgba(255,255,255,.06);
    gap: 8px;
  }
  ul#chats li:hover { background: rgba(106,225,255,.06); }
  small.mono { font-family: ui-monospace, Menlo, Consolas, monospace; color: var(--muted); }

  mark { background: rgba(106,225,255,.18); color: var(--text); padding: 0 3px; border-radius: 4px; }

  /* ===== PRETTY SCROLLBAR (desktop) ===== */
  ul#chats::-webkit-scrollbar, pre::-webkit-scrollbar { height:10px; width:10px; }
  ul#chats::-webkit-scrollbar-thumb, pre::-webkit-scrollbar-thumb {
    background: rgba(106,225,255,.35); border-radius: 100px;
  }
  ul#chats::-webkit-scrollbar-track, pre::-webkit-scrollbar-track { background: transparent; }

  /* ===== PRE blocks ===== */
  pre {
    background: #0d1017;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    max-height: 360px;
    overflow:auto;
    line-height: 1.35;
  }

  /* ===== HEADER STRIP ===== */
  .app-header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 6px;
  }
  .brand-dot {
    width: 9px; height: 9px; border-radius:100%;
    background: radial-gradient(circle at 30% 30%, #fff, var(--primary) 40%, var(--secondary));
    box-shadow: 0 0 12px var(--primary);
    margin-right: 8px;
    display:inline-block;
  }
</style>

  </head>
  <body>
    <h1>Team Mini App</h1>

    <!-- Greeting + MOTD -->
    <div class="card">
      <p id="who"></p>
      <p id="motd" style="margin-top:8px"></p>
    </div>

    <!-- Chats with server-side search -->
    <div class="card">
      <div class="row">
        <button id="loadChats">Load chats</button>
        <input id="chatSearch" class="grow" placeholder="Search chats by title or idâ€¦" />
      </div>
      <ul id="chats"></ul>
    </div>

    <!-- Latest messages -->
    <div class="card">
      <h3>Latest messages</h3>
      <div class="row">
        <input id="chatIdMsgs" class="grow" placeholder="Enter chat_id (e.g., -1001234567890)" />
        <button id="loadMsgs">Load latest messages</button>
      </div>
      <pre id="msgs"></pre>
    </div>

    <!-- Summarize -->
    <div class="card">
      <h3>Summarize</h3>
      <div class="row">
        <input id="chatIdSum" class="grow" placeholder="Enter chat_id for summary" />
        <input id="sumLimit" style="width:140px" placeholder="How many msgs (e.g., 120)" />
        <button id="doSummary">Summarize</button>
      </div>
      <pre id="summaryOut"></pre>
    </div>

    <!-- Company details (auto + edit) -->
    <div class="card">
      <h3>Company details</h3>
      <div class="row">
        <input id="chatIdCompany" class="grow" placeholder="Enter chat_id for company details" />
        <button id="getCompany">Get company details</button>
        <button id="editCompany">Edit blurb</button>
      </div>
      <pre id="companyOut"></pre>
    </div>

    <!-- Status (auto + edit) -->
    <div class="card">
      <h3>Status</h3>
      <div class="row">
        <input id="chatIdStatus" class="grow" placeholder="Enter chat_id for status" />
        <button id="getStatus">Get status</button>
        <button id="editStatus">Edit status</button>
      </div>
      <pre id="statusOut"></pre>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();

      // Who opened the app
      const user = tg.initDataUnsafe?.user;
      document.getElementById('who').textContent =
        user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) â€” id: ${user.id}`
             : 'Open this from Telegram to see user info.';

      // Day-of-week MOTD
      function motd(name) {
        const day = new Date().toLocaleDateString(undefined, { weekday: 'long' });
        const map = {
          Monday:    "set the tone, plan, and think how you can get to the next step (level-up).",
          Tuesday:   "keep going! It's going greatâ€”knock out the smallest tasks and break big ones into small steps.",
          Wednesday: "take a break and breatheâ€”youâ€™re halfway through the week.",
          Thursday:  "take it easy but stay productive.",
          Friday:    "make a final push and then proudly enjoy your weekend ðŸŽ‰",
          Saturday:  "grab one tiny win and recharge.",
          Sunday:    "lightly prep for the week and enjoy some rest."
        };
        return `Hey ${name}, today is the perfect day to ${map[day] || 'make one meaningful step today.'}`;
      }
      document.getElementById('motd').textContent = motd(user?.first_name || 'there');

      // Main button
      tg.MainButton.setText('Close');
      tg.MainButton.onClick(() => tg.close());
      tg.MainButton.show();

      // Helpers
      const H = () => ({ 'x-telegram-init-data': tg.initData });
      const put = (id, t) => (document.getElementById(id).textContent = t);
      const err = (id, e) => put(id, `Error: ${e?.message || e}`);

      // --- CHATS + SERVER-SIDE SEARCH ---
      let lastSearch = '';
      function highlight(text, needle) {
        if (!needle) return text;
        const re = new RegExp(`(${needle.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'ig');
        return text.replace(re, '<mark>$1</mark>');
      }
      async function fetchChats(q = '') {
        const url = q ? `/api/chats?q=${encodeURIComponent(q)}` : '/api/chats';
        const res = await fetch(url, { headers: H() });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        return res.json();
      }
      async function renderChats(q = '') {
        try {
          lastSearch = q.trim();
          const chats = await fetchChats(lastSearch);
          const ul = document.getElementById('chats');
          ul.innerHTML = chats.map(c => {
            const title = c.title || '';
            const idStr = String(c.id);
            return `<li>${highlight(title, lastSearch)} <small class="mono">(${highlight(idStr, lastSearch)})</small></li>`;
          }).join('');
        } catch (e) { err('chats', e); }
      }
      document.getElementById('loadChats').onclick = () => renderChats('');
      document.getElementById('chatSearch').addEventListener('input', (e) => {
        renderChats(e.target.value);
      });

      // --- LATEST MESSAGES ---
      document.getElementById('loadMsgs').onclick = async () => {
        try {
          const id = document.getElementById('chatIdMsgs').value.trim();
          if (!id) return alert('Enter chat_id');
          const res = await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=50`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const msgs = await res.json();
          put('msgs', msgs.map(m => `${m.date}  [${m.sender_id}]  ${m.text || ''}`).join('\n\n'));
        } catch (e) { err('msgs', e); }
      };

      // --- SUMMARY ---
      document.getElementById('doSummary').onclick = async () => {
        try {
          const id = document.getElementById('chatIdSum').value.trim();
          const lim = parseInt(document.getElementById('sumLimit').value.trim() || '120', 10);
          if (!id) return alert('Enter chat_id');
          const res = await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=${lim}`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (data.text) put('summaryOut', data.text);
          else put('summaryOut', `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`);
        } catch (e) { err('summaryOut', e); }
      };

      // --- COMPANY DETAILS (AUTO + EDIT) ---
      document.getElementById('getCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          const res = await fetch(`/api/company-auto?chat_id=${encodeURIComponent(id)}`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          put('companyOut', data?.text || data?.blurb || data?.note || 'No blurb found.');
        } catch (e) { err('companyOut', e); }
      };

      document.getElementById('editCompany').onclick = async () => {
        const id = document.getElementById('chatIdCompany').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          let current = '';
          try {
            const r0 = await fetch(`/api/blurb-get?chat_id=${encodeURIComponent(id)}`, { headers: H() });
            if (r0.ok) {
              const j0 = await r0.json();
              current = j0?.blurb || '';
            }
          } catch (_) {}
          const updated = prompt('Edit company blurb:', current);
          if (updated == null) return;
          const r = await fetch('/api/blurb-set', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...H() },
            body: JSON.stringify({ chat_id: id, blurb: updated })
          });
          const j = await r.json();
          if (!r.ok || !j.ok) throw new Error(j.error || 'save failed');
          put('companyOut', updated || '(empty)');
        } catch (e) { err('companyOut', e); }
      };

      // --- STATUS (AUTO + EDIT) ---
      const STATUS_LABELS = [
        'Talking stage','Awaiting SoW','SoW signed',
        'Preparing campaign','Campaign live','Awaiting report','Campaign finished'
      ];

      document.getElementById('getStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) return alert('Enter chat_id');
        try {
          const res = await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers: H() });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          put('statusOut', data?.status || 'No status.');
        } catch (e) { err('statusOut', e); }
      };

      document.getElementById('editStatus').onclick = async () => {
        const id = document.getElementById('chatIdStatus').value.trim();
        if (!id) return alert('Enter chat_id');
        const choice = prompt('Set status to one of:\n' + STATUS_LABELS.join('\n'), STATUS_LABELS[0]);
        if (!choice) return;
        if (!STATUS_LABELS.includes(choice)) return alert('Unknown status. Choose exactly from the list.');
        try {
          const r = await fetch('/api/status-set', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...H() },
            body: JSON.stringify({ chat_id: id, status: choice })
          });
          const j = await r.json();
          if (!r.ok || !j.ok) throw new Error(j.error || 'save failed');
          put('statusOut', `${choice} (manual)`);
        } catch (e) { err('statusOut', e); }
      };
    </script>
  </body>
</html>
