<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TRBE — Team Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1:#0b0a0d; --bg-2:#131017;
      --text:#EDEAF5; --muted:#B9B4C8;
      --stroke:rgba(255,255,255,.12);
      --glass-weak:rgba(255,255,255,.06);
      --glass-strong:rgba(255,255,255,.12);
      --accent-1:#6D4AFF; --accent-2:#B075FF; /* TRBE style gradient */
      --brand:#b142b4; /* your purple */
      --radius:16px; --radius-lg:18px;
      --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
      --font:"Manrope",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:var(--font); -webkit-font-smoothing:antialiased;
      /* smooth layered background, no banding */
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(109,74,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(44,227,255,.15), transparent 55%),
        radial-gradient(1400px 900px at 80% 120%, rgba(177,66,180,.22), transparent 60%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      padding:18px 16px 28px;
    }
    .wrap{max-width:980px; margin:0 auto;}

    /* header (centered only here) */
    .hero{display:grid; gap:8px; margin:6px 0 18px; text-align:center;}
    .pill{
      display:inline-block; font-size:12px; color:var(--muted);
      border:1px solid var(--stroke); border-radius:999px; padding:6px 10px;
      backdrop-filter:blur(10px);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    h1{
      font-size:clamp(28px,4.8vw,44px); line-height:1.05; margin:2px 0 0;
      font-weight:800; letter-spacing:-.5px;
    }
    .gradient{
      background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .motd{color:var(--muted); font-size:14px; margin-top:4px;}

    /* grid layout (rest left-aligned) */
    .grid{display:grid; gap:14px; grid-template-columns:1fr;}
    @media (min-width:860px){ .grid{grid-template-columns:1.1fr 1fr;} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h3{font-size:16px; margin:0 0 10px; font-weight:700;}

    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    input, textarea, select{
      width:100%; color:var(--text);
      background:rgba(255,255,255,.03); border:1px solid var(--stroke);
      border-radius:12px; padding:10px 12px; outline:none;
    }
    textarea{min-height:110px; resize:vertical}

    .btn{
      appearance:none; border:0; color:#fff; font-weight:800;
      padding:12px 16px; border-radius:14px; cursor:pointer;
      background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
      box-shadow:0 8px 20px rgba(109,74,255,.25), inset 0 1px 0 rgba(255,255,255,.12);
      transition:transform .05s ease, filter .15s ease; white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
    }
    .btn.mini{padding:8px 12px; font-size:13px; border-radius:12px}

    .two{display:grid; gap:10px; grid-template-columns:1fr 150px; align-items:center}
    .three{display:grid; gap:10px; grid-template-columns:1fr 140px 110px}
    @media (max-width:560px){ .two{grid-template-columns:1fr} .three{grid-template-columns:1fr} }

    .list{list-style:none; padding:0; margin:8px 0 0; max-height:260px; overflow:auto; border:1px solid var(--stroke); border-radius:12px;}
    .row{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02); cursor:pointer}
    .row:hover{background:rgba(255,255,255,.06)} .row:last-child{border-bottom:0}
    .sub{font-size:12px; color:var(--muted)}
    .badge{padding:2px 8px; border-radius:999px; background:linear-gradient(90deg, var(--accent-1), var(--accent-2)); font-size:11px; font-weight:800; letter-spacing:.2px}

    pre.out{background:rgba(0,0,0,.35); border:1px solid var(--stroke); border-radius:12px; padding:10px; margin:10px 0 0; white-space:pre-wrap; max-height:280px; overflow:auto}
    .note{color:var(--muted); font-size:12px; margin-top:6px}
    .hint{color:var(--muted); font-size:12px}

    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    hr.split{border:none; border-top:1px solid var(--stroke); margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- centered only on hero -->
    <div class="hero">
      <span class="pill">TRBE Team Mini App</span>
      <h1>Top Web3 ops, one panel. <span class="gradient">TRBE</span></h1>
      <div id="who" class="motd"></div>
      <div id="motd" class="motd"></div>
    </div>

    <div class="grid">

      <!-- CHATS -->
      <section class="card">
        <h3>Chats <span class="badge" id="chCount">0</span></h3>
        <div class="toolbar">
          <div class="two" style="grid-template-columns:1fr 160px">
            <input id="searchChats" placeholder="Search chats by title, @username, or id…" />
            <button class="btn" id="loadChats">Load chats</button>
          </div>
        </div>
        <ul id="chats" class="list"></ul>
        <div class="note">Tip: click a chat to fill all inputs below.</div>
      </section>

      <!-- SUMMARY -->
      <section class="card">
        <h3>Quick Summary</h3>
        <div class="two">
          <input id="chatIdSum" placeholder="Enter chat_id for summary" />
          <button class="btn" id="doSummary">Summarize</button>
        </div>
        <pre id="summaryOut" class="out"></pre>
      </section>

      <!-- LATEST MESSAGES (5 only) -->
      <section class="card">
        <h3>Latest Messages</h3>
        <div class="two">
          <input id="chatIdMsg" placeholder="Enter chat_id for messages" />
          <button class="btn" id="loadMsgs">Load latest</button>
        </div>
        <pre id="msgsOut" class="out"></pre>
        <div class="hint">Shows only the last 5 messages.</div>
      </section>

      <!-- COMPANY + STATUS -->
      <section class="card">
        <h3>Company & Status</h3>

        <!-- Blurb -->
        <div class="three">
          <input id="chatIdCompany" placeholder="Enter chat_id for blurb" />
          <button class="btn" id="getBlurb">Get blurb</button>
          <button class="btn secondary" id="editBlurb">Edit</button>
        </div>
        <div id="blurbView"><pre id="blurbOut" class="out">No blurb found.</pre></div>
        <div id="blurbEdit" style="display:none; margin-top:8px">
          <textarea id="blurbArea" placeholder="Edit blurb…"></textarea>
          <div class="inline" style="margin-top:8px">
            <button class="btn mini" id="saveBlurb">Save</button>
            <button class="btn secondary mini" id="cancelBlurb">Cancel</button>
          </div>
        </div>

        <hr class="split" />

        <!-- Status -->
        <div class="three">
          <input id="chatIdStatus" placeholder="Enter chat_id for status" />
          <button class="btn" id="getStatus">Get status</button>
          <button class="btn secondary" id="editStatus">Edit</button>
        </div>
        <div id="statusView"><pre id="statusOut" class="out">—</pre></div>
        <div id="statusEdit" style="display:none; margin-top:8px">
          <select id="statusSel">
            <option>Talking stage</option>
            <option>Awaiting SoW</option>
            <option>SoW signed</option>
            <option>Preparing campaign</option>
            <option>Campaign live</option>
            <option>Awaiting report</option>
            <option>Campaign finished</option>
          </select>
          <div class="inline" style="margin-top:8px">
            <button class="btn mini" id="saveStatus">Save</button>
            <button class="btn secondary mini" id="cancelStatus">Cancel</button>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // Telegram boot
    const tg = window.Telegram?.WebApp; tg?.ready?.();
    const user = tg?.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) — id: ${user.id}` : 'Open this from Telegram to see user info.';
    const day = new Date().getDay();
    const motdMap = {
      1:'Monday — set the tone: plan the week and identify one “level-up” step.',
      2:'Tuesday — momentum day! Kill the smallest tasks and split big ones.',
      3:'Wednesday — breathe, you’re half-way through. Review blockers.',
      4:'Thursday — keep steady progress, stay productive without burning out.',
      5:'Friday — final push, then enjoy the weekend. Tie loose ends.',
      0:'Sunday — light planning beats heavy grinding. Prep your week.',
      6:'Saturday — rest & reflect. Tiny wins only.'
    };
    document.getElementById('motd').textContent = motdMap[day] || '';
    tg?.MainButton?.setText?.('Close'); tg?.MainButton?.onClick?.(()=>tg.close()); tg?.MainButton?.show?.();

    // helper
    const H = {
      headers(){ return {'x-telegram-init-data': tg?.initData || ''}; },
      set(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; },
      pickChat(id){
        ['chatIdMsg','chatIdSum','chatIdCompany','chatIdStatus'].forEach(k=>{
          const el=document.getElementById(k); if(el) el.value=id;
        });
      }
    };

    // CHATS + search
    const chatsList = document.getElementById('chats');
    const chCount = document.getElementById('chCount');
    let chatsCache = [];

    async function loadChats(){
      chatsList.innerHTML = `<li class="row"><div>Loading…</div></li>`;
      try{
        const r = await fetch('/api/chats', { headers:H.headers() });
        if(!r.ok) throw new Error(await r.text());
        chatsCache = await r.json();
        renderChats(chatsCache); chCount.textContent = chatsCache.length;
      }catch(e){
        chatsList.innerHTML = `<li class="row"><div>Failed</div><div class="sub">${e.message||e}</div></li>`;
      }
    }
    function renderChats(items){
      if(!items?.length){ chatsList.innerHTML = `<li class="row"><div>Nothing found</div></li>`; return; }
      chatsList.innerHTML = items.map(c=>{
        const uname = c.username ? `@${c.username}` : '';
        return `<li class="row" data-id="${c.id}">
          <div><div>${c.title}</div><div class="sub">${uname?uname+' • ':''}${c.id}</div></div>
          <div class="badge">Pick</div>
        </li>`;
      }).join('');
    }
    document.getElementById('loadChats').onclick = loadChats;
    chatsList.addEventListener('click', e=>{
      const li=e.target.closest('.row'); if(!li) return;
      const id=li.getAttribute('data-id'); H.pickChat(id);
    });
    document.getElementById('searchChats').addEventListener('input', e=>{
      const q=e.target.value.trim().toLowerCase();
      if(!q){ renderChats(chatsCache); chCount.textContent=chatsCache.length; return; }
      const f=chatsCache.filter(c =>
        String(c.id).includes(q) || (c.title||'').toLowerCase().includes(q) || (c.username||'').toLowerCase().includes(q)
      );
      renderChats(f); chCount.textContent=f.length;
    });

    // LATEST MESSAGES (limit 5)
    document.getElementById('loadMsgs').onclick = async ()=>{
      const id=document.getElementById('chatIdMsg').value.trim();
      if(!id) return alert('Enter chat_id');
      H.set('msgsOut','Loading…');
      try{
        const r=await fetch(`/api/messages-latest?chat_id=${encodeURIComponent(id)}&limit=5`, { headers:H.headers() });
        if(!r.ok) throw new Error(await r.text());
        const msgs=await r.json();
        H.set('msgsOut', msgs?.length ? msgs.map(m=>`${m.date}  [${m.sender_id}]  ${m.text||''}`).join('\n\n') : 'No messages.');
      }catch(e){ H.set('msgsOut',`Error: ${e.message||e}`); }
    };

    // SUMMARY
    document.getElementById('doSummary').onclick = async ()=>{
      const id=document.getElementById('chatIdSum').value.trim();
      if(!id) return alert('Enter chat_id');
      H.set('summaryOut','Summarizing…');
      try{
        const r=await fetch(`/api/summary?chat_id=${encodeURIComponent(id)}&limit=160`, { headers:H.headers() });
        if(!r.ok) throw new Error(await r.text());
        const data=await r.json();
        H.set('summaryOut', data.text ? data.text :
          `Model: ${data.model}\n\nPoints:\n${(data.bullets||[]).join('\n')}\n\nActions:\n${(data.actions||[]).join('\n')}`);
      }catch(e){ H.set('summaryOut',`Error: ${e.message||e}`); }
    };

    // BLURB (GET + EDIT)
    const blurbView = document.getElementById('blurbView');
    const blurbEdit = document.getElementById('blurbEdit');
    const blurbOut  = document.getElementById('blurbOut');
    const blurbArea = document.getElementById('blurbArea');

    document.getElementById('getBlurb').onclick = async ()=>{
      const id=document.getElementById('chatIdCompany').value.trim();
      if(!id) return alert('Enter chat_id');
      H.set('blurbOut','Loading…');
      try{
        const r=await fetch(`/api/company-blurb?chat_id=${encodeURIComponent(id)}`, { headers:H.headers() });
        if(!r.ok) throw new Error(await r.text());
        const data=await r.json();
        blurbOut.textContent = data.blurb ? data.blurb : (data.note || 'No blurb found.');
      }catch(e){ blurbOut.textContent=`Error: ${e.message||e}`; }
    };

    document.getElementById('editBlurb').onclick = ()=>{
      blurbArea.value = blurbOut.textContent && blurbOut.textContent!=='No blurb found.' ? blurbOut.textContent : '';
      blurbView.style.display='none'; blurbEdit.style.display='';
    };
    document.getElementById('cancelBlurb').onclick = ()=>{
      blurbEdit.style.display='none'; blurbView.style.display='';
    };
    document.getElementById('saveBlurb').onclick = async()=>{
      const id=document.getElementById('chatIdCompany').value.trim();
      if(!id) return alert('Enter chat_id');
      const blurb=blurbArea.value.trim();
      try{
        const r=await fetch('/api/company', {
          method:'POST',
          headers:{'Content-Type':'application/json', ...H.headers()},
          body:JSON.stringify({ chat_id:id, blurb })
        });
        await r.text();
        blurbOut.textContent = blurb || 'No blurb found.';
      }finally{
        blurbEdit.style.display='none'; blurbView.style.display='';
      }
    };

    // STATUS (GET + EDIT)
    const statusView=document.getElementById('statusView');
    const statusEdit=document.getElementById('statusEdit');
    const statusOut=document.getElementById('statusOut');
    const statusSel=document.getElementById('statusSel');

    document.getElementById('getStatus').onclick = async ()=>{
      const id=document.getElementById('chatIdStatus').value.trim();
      if(!id) return alert('Enter chat_id');
      H.set('statusOut','Loading…');
      try{
        const r=await fetch(`/api/status-auto?chat_id=${encodeURIComponent(id)}&limit=200`, { headers:H.headers() });
        if(!r.ok) throw new Error(await r.text());
        const data=await r.json();
        statusOut.textContent = data?.status || '—';
      }catch(e){ statusOut.textContent=`Error: ${e.message||e}`; }
    };

    document.getElementById('editStatus').onclick = ()=>{
      const cur=statusOut.textContent.trim();
      if(Array.from(statusSel.options).some(o=>o.value===cur)) statusSel.value=cur;
      statusView.style.display='none'; statusEdit.style.display='';
    };
    document.getElementById('cancelStatus').onclick = ()=>{
      statusEdit.style.display='none'; statusView.style.display='';
    };
    document.getElementById('saveStatus').onclick = async ()=>{
      const id=document.getElementById('chatIdStatus').value.trim();
      if(!id) return alert('Enter chat_id');
      const status=statusSel.value;
      try{
        const r=await fetch('/api/status', {
          method:'POST',
          headers:{'Content-Type':'application/json', ...H.headers()},
          body:JSON.stringify({ chat_id:id, status })
        });
        await r.text();
        statusOut.textContent=status;
      }finally{
        statusEdit.style.display='none'; statusView.style.display='';
      }
    };
  </script>
</body>
</html>
