<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TRBE — Team Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #0b0a0d;
      --bg-2: #131017;
      --text: #EDEAF5;
      --muted: #B9B4C8;
      --stroke: rgba(255, 255, 255, .12);
      --radius: 16px;
      --radius-lg: 18px;
      --shadow: 0 10px 30px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .03);
      --accent-1: #b142b4;
      --accent-2: #c27bff;
      --glass: rgba(255, 255, 255, .06);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      background-attachment: fixed;
      background-image:
        radial-gradient(1200px 800px at 20% -10%, rgba(177, 66, 180, .22), transparent 60%),
        radial-gradient(1100px 700px at 90% 0%, rgba(194, 123, 255, .18), transparent 55%),
        radial-gradient(1400px 900px at 80% 120%, rgba(177, 66, 180, .16), transparent 60%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      background-blend-mode: screen, screen, screen, normal;
      padding: 18px 16px max(28px, calc(env(safe-area-inset-bottom) + 90px));
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    .hero {
      display: grid;
      gap: 8px;
      margin: 6px 0 18px;
      text-align: center;
    }

    .pill {
      display: inline-block;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .03));
    }

    h1 {
      font-size: clamp(28px, 4.8vw, 44px);
      line-height: 1.05;
      margin: 2px 0 0;
      font-weight: 800;
      letter-spacing: -.5px
    }

    .gradient {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent
    }

    .motd {
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px
    }

    .three-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
      margin: 16px 0 8px
    }

    @media (min-width:860px) {
      .three-grid {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    .tile {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 26px;
      cursor: pointer;
      text-align: center;
      transition: transform .05s ease, filter .15s ease;
    }

    .tile:hover {
      filter: brightness(1.06)
    }

    .tile:active {
      transform: translateY(1px)
    }

    .tile h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 800
    }

    .panel {
      display: none;
      margin-top: 16px;
      position: relative
    }

    .back {
      position: absolute;
      right: 10px;
      top: -6px;
      appearance: none;
      border: 0;
      color: #fff;
      font-weight: 800;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      box-shadow: 0 8px 20px rgba(177, 66, 180, .28), inset 0 1px 0 rgba(255, 255, 255, .12);
    }

    .card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
      backdrop-filter: blur(8px);
    }

    .card h3 {
      font-size: 16px;
      margin: 0 0 10px;
      font-weight: 800
    }

    .hint {
      color: var(--muted);
      font-size: 12px
    }

    .toolbar {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      margin-bottom: 10px
    }

    @media (min-width:700px) {
      .toolbar {
        grid-template-columns: 1fr 260px
      }
    }

    input,
    textarea,
    select {
      width: 100%;
      color: var(--text);
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px 14px;
      outline: none;
    }

    textarea {
      min-height: 110px;
      resize: vertical
    }

    .btn {
      appearance: none;
      border: 0;
      color: #fff;
      font-weight: 800;
      padding: 14px 16px;
      border-radius: 16px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      box-shadow: 0 8px 20px rgba(177, 66, 180, .28), inset 0 1px 0 rgba(255, 255, 255, .12);
      transition: transform .05s ease, filter .15s ease;
      white-space: nowrap;
    }

    .btn:hover {
      filter: brightness(1.06)
    }

    .btn:active {
      transform: translateY(1px)
    }

    .btn.secondary {
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .04));
      color: var(--text);
    }

    .btn.mini {
      padding: 9px 12px;
      font-size: 13px;
      border-radius: 12px
    }

    .btn:disabled {
      opacity: .6;
      filter: grayscale(40%)
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      overflow: hidden
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      background: rgba(255, 255, 255, .03);
      cursor: pointer;
    }

    .row:hover {
      background: rgba(255, 255, 255, .07)
    }

    .row:last-child {
      border-bottom: 0
    }

    .title {
      font-weight: 700
    }

    .sub {
      font-size: 12px;
      color: var(--muted)
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .2px;
      justify-self: end;
    }

    pre.out {
      background: rgba(0, 0, 0, .35);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0 0;
      white-space: pre-wrap;
      max-height: 280px;
      overflow: auto
    }

    .section-title {
      font-weight: 800;
      margin: 10px 0 8px
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <div class="hero">
      <span class="pill">TRBE Team Mini App</span>
      <h1>Get info without browsing chats. <span class="gradient">TRBE</span></h1>
      <div id="who" class="motd"></div>
      <div id="motd" class="motd"></div>
    </div>

    <!-- Landing: three boxes -->
    <div id="landing" class="three-grid">
      <div class="tile" data-open="panel-chats"><h2>Chats</h2></div>
      <div class="tile" data-open="panel-team"><h2>Team</h2></div>
      <div class="tile" data-open="panel-ai"><h2>AI Assistant</h2></div>
    </div>
    <!-- PANEL: CHATS -->
    <div id="panel-chats" class="panel">
      <button class="back" data-back>Back to Main</button>

      <section class="card">
        <h3>Dashboard</h3>
        <div class="toolbar" style="grid-template-columns: 1fr 220px;">
          <input id="searchChats" placeholder="Search chats by title, @username, or id…" />
          <select id="statusFilter" title="Filter by status">
            <option value="">All statuses</option>
            <option>Talking</option><option>Awaiting data</option><option>Awaiting SoW</option>
            <option>SoW signed</option><option>Awaiting payment</option><option>Paid</option>
            <option>Data collection</option><option>Campaign launched</option><option>Report awaiting</option><option>Finished</option>
          </select>
        </div>
        <ul id="chats" class="list"></ul>
        <div class="hint">Tip: click a chat to auto-fill all tools below.</div>
      </section>

      <!-- Add your other CHATS panel content here (cards, timelines, tools, etc.) -->
      <!-- You already have this in your original code, so continue from here -->

    </div>

    <!-- PANEL: TEAM -->
    <div id="panel-team" class="panel">
      <button class="back" data-back>Back to Main</button>
      <section class="card">
        <h3>Team</h3>
        <div class="toolbar" style="grid-template-columns: 1fr 200px;">
          <input id="taskSearch" placeholder="Search tasks…" />
          <select id="teamSelect">
            <option value="">Choose a teammate…</option>
            <option value="@Shefer712">Arina — @Shefer712</option>
            <option value="@Web3Reachout">Kate — @Web3Reachout</option>
            <option value="@travalss">Val — @travalss</option>
            <option value="@phoebemangoba">Phoebe — @phoebemangoba</option>
          </select>
        </div>
        <div class="hint">Tasks UI — coming soon.</div>
      </section>
    </div>

    <!-- PANEL: AI -->
    <div id="panel-ai" class="panel">
      <button class="back" data-back>Back to Main</button>
      <section class="card">
        <h3>AI Assistant</h3>

        <!-- Chat dropdown -->
        <div class="toolbar" style="grid-template-columns: 1fr;">
          <select id="aiChatSelect">
            <option value="">Choose a chat…</option>
          </select>
        </div>

        <!-- Prompt + button -->
        <div class="toolbar" style="grid-template-columns: 1fr 140px; margin-top: 10px;">
          <input id="aiPrompt" placeholder="Ask a question to the AI assistant…" />
          <button class="btn" id="askAiBtn">Ask</button>
        </div>

        <!-- Response output -->
        <pre id="aiResponse" class="out" style="margin-top: 12px">—</pre>
      </section>
    </div>

  </div>
  <script>
    /* Telegram setup */
    const tg = window.Telegram?.WebApp; 
    tg?.ready?.(); tg?.expand?.();
    const user = tg?.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      user ? `Hello, ${user.first_name} (@${user.username || 'no username'}) — id: ${user.id}` : 
              'Open this from Telegram to see user info.';
    const motdMap = {
      0:'Sunday — light planning beats heavy grinding. Prep your week.',
      1:'Monday — set the tone: plan the week and identify one “level-up” step.',
      2:'Tuesday — momentum day! Kill the smallest tasks and split big ones.',
      3:'Wednesday — breathe, you’re half-way through. Review blockers.',
      4:'Thursday — keep steady progress, stay productive without burning out.',
      5:'Friday — final push, then enjoy the weekend. Tie loose ends.',
      6:'Saturday — rest & reflect. Tiny wins only.'
    };
    document.getElementById('motd').textContent = motdMap[new Date().getDay()] || '';
    tg?.MainButton?.setText?.('Close'); 
    tg?.MainButton?.onClick?.(()=>tg.close()); 
    tg?.MainButton?.show?.();

    /* Routing */
    const landing = document.getElementById('landing');
    const panels = {
      'panel-chats': document.getElementById('panel-chats'),
      'panel-team': document.getElementById('panel-team'),
      'panel-ai': document.getElementById('panel-ai')
    };
    document.querySelectorAll('.tile').forEach(tile=>{
      tile.addEventListener('click', ()=>{
        const id = tile.dataset.open;
        landing.style.display='none'; 
        Object.values(panels).forEach(p=>p.style.display='none');
        panels[id].style.display='block';
        if (id === 'panel-chats') loadChats();
        if (id === 'panel-ai') { loadChats().then(populateAiChatSelect); }
      });
    });
    document.querySelectorAll('[data-back]').forEach(b=>{
      b.addEventListener('click', ()=>{
        Object.values(panels).forEach(p=>p.style.display='none');
        landing.style.display='grid';
      });
    });

    /* Accordion toggles */
    document.querySelectorAll('.acc-item .acc-head').forEach(h=>{
      h.addEventListener('click', ()=> h.parentElement.classList.toggle('open'));
    });

    /* Helper utils */
    const H = {
      headers(){ return {'x-telegram-init-data': tg?.initData || ''}; },
      pickChat(id){ 
        ['chatIdSum','chatIdStatus','chatIdCompany','chatIdDatesProd','chatIdDatesCamp','chatIdNext']
          .forEach(k=>{ const el=document.getElementById(k); if(el) el.value=id; });
      },
      fmtStatus(s){ return s || '—'; }
    };

    /* Chats data */
    let chatsCache = [];
    const chatsList = document.getElementById('chats');

    async function loadChats(){
      if (chatsCache.length) return chatsCache;
      chatsList.innerHTML = `<li class="row"><div>Loading…</div></li>`;
      try{
        const r = await fetch('/api/chats',{headers:H.headers()});
        const data = await r.json();
        if(!r.ok){ chatsList.innerHTML=`<li class="row"><div>Error loading chats</div></li>`; return []; }
        chatsCache = data || [];
        renderChats();
      }catch(e){
        chatsList.innerHTML=`<li class="row"><div>Network error: ${e.message}</div></li>`;
      }
      return chatsCache;
    }

    function renderChats(){
      const q=document.getElementById('searchChats').value.trim().toLowerCase();
      const f=document.getElementById('statusFilter').value;
      const items=(chatsCache||[]).filter(c=>{
        const matchQ=!q||String(c.id).includes(q)||(c.title||'').toLowerCase().includes(q)||(c.username||'').toLowerCase().includes(q);
        const matchS=!f||(c.status===f);
        return matchQ&&matchS;
      });
      if(!items.length){chatsList.innerHTML='<li class="row"><div>No chats found.</div></li>';return;}
      chatsList.innerHTML=items.map(c=>{
        const uname=c.username?`@${c.username}`:'';
        return `<li class="row" data-id="${c.id}">
          <div><div class="title">${c.title||'(no title)'}</div>
          <div class="sub">${uname?uname+' • ':''}${c.id}</div></div>
          <div class="status-pill">${H.fmtStatus(c.status)}</div></li>`;
      }).join('');
      chatsList.querySelectorAll('.row').forEach(li=>{
        li.addEventListener('click',()=>{
          const id=li.dataset.id;H.pickChat(id);
          chatsList.querySelectorAll('.row').forEach(x=>x.style.outline='none');
          li.style.outline='2px solid rgba(194,123,255,.6)';
        });
      });
    }

    document.getElementById('searchChats').addEventListener('input',renderChats);
    document.getElementById('statusFilter').addEventListener('change',renderChats);

    /* ----------------- AI ASSISTANT ------------------ */
    async function populateAiChatSelect(){
      const sel=document.getElementById('aiChatSelect');
      if(!sel)return;
      if(!chatsCache.length) await loadChats();
      sel.innerHTML='<option value="">Choose a chat…</option>'+
        chatsCache.map(c=>{
          const t=c.title||'(no title)';
          const u=c.username?`@${c.username}`:'';
          return `<option value="${c.id}">${t}${u?' • '+u:''} • ${c.id}</option>`;
        }).join('');
    }

    document.querySelector('[data-open="panel-ai"]')?.addEventListener('click',populateAiChatSelect);

    document.getElementById('askAiBtn')?.addEventListener('click',async()=>{
      const chatId=document.getElementById('aiChatSelect').value;
      const prompt=document.getElementById('aiPrompt').value.trim();
      const out=document.getElementById('aiResponse');
      if(!chatId)return alert('Please select a chat');
      if(!prompt)return alert('Please enter a question');
      out.textContent='Thinking…';
      try{
        const r=await fetch('/api/ai-assistant',{
          method:'POST',
          headers:{'Content-Type':'application/json','x-telegram-init-data':tg?.initData||''},
          body:JSON.stringify({chat_id:chatId,prompt})
        });
        const data=await r.json();
        if(!r.ok) out.textContent=`Error (${r.status}): ${data?.error||'Unknown'}`;
        else out.textContent=data?.text||'(No response)';
      }catch(e){ out.textContent=`Network error: ${e.message||e}`; }
    });
  </script>
</body>
</html>
